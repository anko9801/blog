---
title: "glibc heap exploitation を支える技術"
---

この記事を和訳します。
https://0x434b.dev/overview-of-glibc-heap-exploitation-techniques/

この記事では広く知られている GLIBC heap exploitation の技術の全体像を見ることを目的としています。実際の攻撃は読者への課題とします。blah blah

64-bit system

## Heap Exploit の基礎
### Chunks
チャンクサイズとデータサイズは違います。チャンクはデータの前に 0x10 分のメタデータを使います。
malloc はデータサイズ0x10ごとに
チャンクサイズを基本に扱います。
free allocated

![[Pasted image 20221228215339.png]]

### Bins
Bins とは free されたチャンクのリストです。Bins はチャンクのサイズによって管理の仕方が異なります。次にそれらを簡単に紹介します。
チャンクのリサイクルをすることで最適化する

#### fastbins
tcache が既にいっぱいのとき、チャンクサイズが 0x20 から 0xb0 なら fastbins という LIFO の単方向連結リストに繋がれます。fastbins はサイズに合わせて 0x20, 0x30, ..., 0xa0, 0xb0 と全部で 10 個あり、それぞれ同じ大きさのチャンクを格納しています。各 fastbin の先頭は arena にあります。チャンクのデータの最初の qword は fastbins の次のチャンクを指す forward pointer (fd) でが置かれ、リストの最後の fd は NULL になります。
fastbins の範囲のチャンクサイズのメモリ確保を行う場合、tcachebin->fastbin->unsortedbin->top_chunkの順に探します。

![[Pasted image 20221228220533.png]]

#### smallbins
unsortedbins でソートが起こったとき、チャンクサイズが 0x20 から 0x3f0 なら smallbins という FIFO の双方向循環リストに繋がれます。62個の各 smallbins の先頭は arena にあります。

![[Pasted image 20221229000853.png]]

#### unsortedbin
更にキャッシュ最適化をする
任意の大きさのチャンクは unsortedbin という双方向循環リストに繋がれます。unsortedbin は1つのみリストの先頭と末尾は arena にあります。0x80先頭に挿入されます。

fastbins -> smallbins -> unsortedbins

![[Pasted image 20221229003524.png]]

#### largebins
largebins という双方向循環リストに繋がれます。先頭は arena にあります。
fastbins や smallbins とは違い、just-fitなチャンクではなくある範囲のチャンクサイズ
forward, back へのポインタに加え
largebins の構造がわからない？
largebins から確保されたメモリは `last_remainder` はセットされない。

last_remainder
要求のあったサイズと合致するchunkが見つからない場合、既存のchunkを要求サイズで分割する場合があります。残りの領域は新たなchunkとして登録されます。last_remainderはこの時の残りのchunkの内、最新のアドレスを格納します。

![[Pasted image 20221229003544.png]]

#### tcache (per-thread cache) bins
64 tcache bins

![[Pasted image 20221229003517.png]]

#### Arena
arena は malloc が使う為の状態構造体以上の何物でもない。

mmap
128KB

疑問
- 同時に2つのbinsに入ることはあるのか？
