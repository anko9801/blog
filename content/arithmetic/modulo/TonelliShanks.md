---
title: "Tonelli Shanks"
---
$$
\newcommand{\ZZ}{\mathbb{Z}}
$$

## 概説
$p$ を素数として任意の $a\in\ZZ/p\ZZ$ に対し $x^2 = a$ となる $x$ を求めることができるアルゴリズムである。

まずアイデアを一通り説明しておくと、フェルマーの小定理から $x^2 = a = a^p$ であり、やりたいことは $x = a^{p/2}$ である。しかし $p$ は奇数なので整数累乗ではなく不可能。そこでまずは次のように分解することで整数累乗ができる代数 $\ZZ/q\ZZ$ から $x' = a^{(q+1)/2}$ を計算する。

$$
(\ZZ/p\ZZ)^\times \cong \ZZ/(p-1)\ZZ \cong \ZZ/q\ZZ \times \ZZ/2^Q\ZZ
$$

そうすると $x$ と $x'$ について $\ZZ/q\ZZ$ で合うので $\ZZ/2^Q\ZZ$ も合わせれば完璧である。こちらは $\ZZ/2^Q\ZZ$ での差分を $Q$ 桁の2進数と見なして、下から順に $1$ を $0$ に変換することで誤差を無くし $x$ が求まるといった感じである。

## 詳説

### $\ZZ/q\ZZ$ を合わせる
まずは $\ZZ/q\ZZ$ から $\ZZ/q\ZZ \times \ZZ/2^Q\ZZ$ への写像 $\mathrm{ind}$ を導入する。

**Definition**
$\mathrm{ind}: (\ZZ/p\ZZ)^\times\to \ZZ/q\ZZ \times \ZZ/2^Q\ZZ$
$\mathop{\mathrm{ind}}a = (a_1, a_2)$

$p = 13$ のとき $\ZZ/12\ZZ = \ZZ/3\ZZ\times\ZZ/2^2\ZZ$ となるので次のような表となる。
|  $2^Q\backslash q$  | 0   | 1   | 2   |
| --- | --- | --- | --- |
| 0   | 0   | 4   | 8   |
| 1   | 9   | 1   | 5   |
| 2   | 6   | 10  | 2   |
| 3   | 3   | 7   | 11  |
ここで原始根 $2$ を選ぶと $(\ZZ/13\ZZ)^\times$ と $\ZZ/3\ZZ\times\ZZ/2^2\ZZ$ の対応表が完成する。
| $2^Q\backslash q$ | 0         | 1           | 2          |
| ----------------- | --------- | ----------- | ---------- |
| 0                 | $2^0=1$   | $2^4=3$     | $2^8 = 9$  |
| 1                 | $2^9=5$   | $2^1=2$     | $2^5=6$    |
| 2                 | $2^6=12$  | $2^{10}=10$ | $2^2=4$    |
| 3                 | $2^3 = 8$ | $2^7=11$    | $2^{11}=7$ |


**Proposition**
1. $\mathop{\mathrm{ind}}1 = (0,0)$
2. $\mathop{\mathrm{ind}}ab = \mathop{\mathrm{ind}}a + \mathop{\mathrm{ind}}b = (a_1, a_2) + (b_1, b_2) = (a_1 + b_1, a_2 + b_2)$
3. $\mathop{\mathrm{ind}}a^e = e(a_1,a_2) = (ea_1, ea_2)$

**Proposition**
1. $\mathop{\mathrm{ind}}a^{q} = (0, qa_2)$
2. $\mathop{\mathrm{ind}}a^{2^Q} = (2^Qa_1, 0)$
3. $\mathop{\mathrm{ind}}a^{q2^Q} = \mathop{\mathrm{ind}}a^{p} = \mathop{\mathrm{ind}}1 = (0, 0)$

目標は $x^2 = a$ となる $x$ から $\mathop{\mathrm{ind}}x^2 = (a_1, a_2)$ となる $x$ を見つけることに変化した。
ここで $x' = a^{(q+1)/2}$ とおくと

$$
\begin{aligned}
\mathop{\mathrm{ind}}x' &= \frac{q+1}{2}(a_1, a_2) \\
\mathop{\mathrm{ind}}x'^2 &= (a_1, (q+1)a_2)
\end{aligned}
$$

となり第一要素は一致するようになった。

### $\ZZ/2^Q\ZZ$ を合わせる
次は第一要素を一致させたまま第二要素を動かす。

第二要素の現在の誤差 $E = x'^2a^{-1}$ は $\mathop{\mathrm{ind}}E = (0, w)$ と表される。$\ZZ/2^Q\ZZ$ の元を $Q$ 桁の2進数と考えると、まず $w$ の $S$ 桁目が $1$ であるか判定し、そうであれば $x'$ に $S-1$ 桁目が $1$ である数を足して $S$ 桁目を $0$ にする操作を行えばよい。

#### $w$ の $S$ 桁目が $1$ である判定
$(\ZZ/p\ZZ)^\times$ での2乗と $\ZZ/2^Q\ZZ$ での左シフトを対応させられることが分かる。
$w$ を $Q - S - 1$ 回左シフトした数が $0$ だったら $S$ 桁目は $0$ であり、そうでなければ $1$ である。
$E^{2^{Q-S-1}} \neq 1$

#### $S-1$ 桁目が $1$ である数の生成
まず最下位ビットが $1$ である数は作ることができる。
ある非平方剰余な数 $b$ ($b^{(p-1)/2} = 1$ を満たす $b$ ) を選び、$b^q$

$\mathop{\mathrm{ind}}b = (b_1, b_2)$ と表される。すると $q$ 乗して $\mathop{\mathrm{ind}}b^q = (0, b')$ と表される。

$b'$ を $S-1$ 回左シフトしたものを $\mathop{\mathrm{ind}}x'$ の第二要素に足す。
新しい $x'$ を $x'' = x'(b^q)^{2^{S-1}}$ とする。

$(\ZZ/p\ZZ)^\times$ の視点で考える。

```
w        = 1010110
w << Q-2 = 1000000 or 0000000
b'       = ??????1
b' << 1  = ?????10
```

$a^{1/2}$ は難しい $a^2$ は簡単
右シフトは難しいが左シフトは簡単
