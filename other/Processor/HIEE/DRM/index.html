<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="DRMの仕組みと実装を理解する メモ DRM(Digital Rights Management)とは
 Digital rights management (DRM) is the management of legal access to digital content. Various tools or technological protection measures (TPM)[1] such as access control technologies can restrict the use of proprietary hardware and copyrighted works."><title>DRM</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://anko9801.github.io/blog//icon.png><link href=https://anko9801.github.io/blog/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://anko9801.github.io/blog/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://anko9801.github.io/blog/js/darkmode.5777cdbea4ccb2b68cacc7e904cabb5c.min.js></script>
<script src=https://anko9801.github.io/blog/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://anko9801.github.io/blog/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://anko9801.github.io/blog/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://anko9801.github.io/blog/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://anko9801.github.io/blog/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://anko9801.github.io/blog/",fetchData=Promise.all([fetch("https://anko9801.github.io/blog/indices/linkIndex.7bcb1a783570b55dadf0f7d44415eb8c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://anko9801.github.io/blog/indices/contentIndex.592b3cb2212e51e2f625b6a0ff6fd41e.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://anko9801.github.io/blog",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://anko9801.github.io/blog",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/anko9801.github.io\/blog\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script defer src=https://anko9801.github.io/blog/js/semantic-search.2c776550faf6cf14399b47e62a8e9782.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://anko9801.github.io/blog/>🪴 あやめHex</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>DRM</h1><p class=meta>Last updated
Nov 18, 2022
<a href=https://github.com/anko9801/blog/tree/hugo/content/other/Processor/HIEE/DRM.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#メモ>メモ</a><ol><li><a href=#cdmこれ大事>CDM(これ大事)</a></li><li><a href=#eme>EME</a></li><li><a href=#どうでもいい話>どうでもいい話</a></li></ol></li><li><a href=#todo>TODO</a></li><li><a href=#refs>refs</a></li></ol></nav></details></aside><a href=#drmの仕組みと実装を理解する><h1 id=drmの仕組みと実装を理解する><span class=hanchor arialabel=Anchor># </span>DRMの仕組みと実装を理解する</h1></a><a href=#メモ><h2 id=メモ><span class=hanchor arialabel=Anchor># </span>メモ</h2></a><p>DRM(Digital Rights Management)とは</p><blockquote><p>Digital rights management (DRM) is the management of legal access to digital content. Various tools or technological protection measures (TPM)[1] such as access control technologies can restrict the use of proprietary hardware and copyrighted works.[2] DRM technologies govern the use, modification, and distribution of copyrighted works (such as software and multimedia content), as well as systems that enforce these policies within devices.[3]</p></blockquote><ol><li>マネタイズのために各種assetへのアクセスをコントロールしたい</li><li>物理assetは物理的束縛があるからコントロールしやすい</li><li>degital assetはどうしようね</li><li><strong>DRM</strong>（に関する各種技術スタック）<ul><li><a href=https://en.wikipedia.org/wiki/Digital_rights_management rel=noopener>https://en.wikipedia.org/wiki/Digital_rights_management</a></li><li>DRMはencryption/decryption keysをsecureにstore/deliverする技術（？）<ul><li>DRM protectedな書籍をキャプチャできないのとかはどう解釈できるのか？</li><li>deliverされたkeyにconsumerが直接アクセスできない（はず）</li></ul></li></ul></li></ol><blockquote><p>【マネタイズ】
For example, you could set rules to,</p><ul><li>block people from certain countries,</li><li>allow access to the content for a certain period,</li><li>prevent a user from casting the movie onto a screen,</li><li>block free users from accessing premium content,</li><li>block playback on specific devices,</li><li>etc.</li></ul></blockquote><p>【コア】
encryptしたい人(creator side)とdecryptしたい人(consumer)がいる
第三者(store)がkeyを安全かつ適切なルールに基づいて配布する
<img src=https://md.trap.jp/uploads/upload_5feb762e9db1d37f5cb1159f2012a9e5.png width=auto alt>
【ここまでで実現できていること】</p><ul><li>a high-security level through daily renewal and code rotation</li><li>authentication and rights management (read, write permissions)<ul><li>読み書きの権限を分ける</li><li>複数人が読むことも可能</li><li>コンテンツへの段階的なアクセス</li><li>期限付きの鍵<ul><li>encryptする鍵をどんどん更新していけば最新のコンテンツが見れなくなるみたいなのは理解できる</li><li>画面の直撮りとかは考えないにしてもencrypted+keyを得た時点でdecryptedが得られそうだけどどうやって防いでるんだろう（単純に手間になるように実装されてるからだれもやってないだけ？）</li><li>専用クライアントみたいなのがあるわけだけどそのへんの実装に踏み込まないと分からなさそう？</li></ul></li><li>etc</li></ul></li><li>a well-defined pricing model
【更に実現したいこと】</li><li>コピー防止</li><li>キャプチャ防止</li></ul><hr><ul><li>building blocks<ul><li>EME(Encrypted Media Extensions)<ul><li><a href=https://www.w3.org/2017/07/EME-backgrounder.html rel=noopener>https://www.w3.org/2017/07/EME-backgrounder.html</a></li><li>OS / ブラウザレベルでCDMとのインターフェースになっている</li><li>復号化されたデータが扱われることはない (CDMのみが扱う)</li><li><a href=https://bitmovin.com/digital-rights-management-everything-to-know/ rel=noopener>https://bitmovin.com/digital-rights-management-everything-to-know/</a></li></ul></li><li>CDM(Content Decryption Module)</li><li>AES(Advanced Encryption Standard)<ul><li>みんな知ってるアレ</li></ul></li><li>動画固有<ul><li>ABR(Adaptive Bitrate Streaming)<ul><li>各クライアントの帯域幅に応じて適切な複数bitrateで配信したい</li><li><a href=https://ottverse.com/what-is-abr-video-streaming/ rel=noopener>https://ottverse.com/what-is-abr-video-streaming/</a></li></ul></li><li>CMAF(Common Media Format)<ul><li><blockquote><p>which said that videos can be stored in the fragmented mp4 container format (fmp4). With support from both MPEG-DASH and HLS, you can now create only one set of videos, store it in fmp4 format, and use a common set of files for both protocols.</p></blockquote></li><li><a href=https://mpeg.chiariglione.org/standards/mpeg-a/common-media-application-format rel=noopener>https://mpeg.chiariglione.org/standards/mpeg-a/common-media-application-format</a></li></ul></li></ul></li><li>CENC(Common Encryption)<ul><li>storeが違う暗号化方式を採用してるとcreatorがダルいので共通化しようと言うモチベ</li><li><blockquote><p>specifying that videos can be encrypted using either cenc (AES-128 CTR) or cbcs (AES-128 CBC). CTR stands for Counter; and CBC stands for Cipher Block Chaining.</p></blockquote></li></ul></li><li>Keys & Key Servers.<ul><li>keyとencrypted contentはKeyIDで紐づく</li><li>KeyIDはmanifestにのってる</li></ul></li></ul></li></ul><p><img src=https://md.trap.jp/uploads/upload_09363d2df17afc60ec315fde1b1a9fb5.png width=auto alt></p><p>現実のカスポイント</p><blockquote><p>Well, CENC might sound like a magic wand for DRM-unification, but it is not.</p><p>There are three primary DRM technologies in the market – Apple FairPlay, Google Widevine, and Microsoft PlayReady.</p><p>Apple FairPlay supports only AES-CBC cbcs mode.
HLS supports only AES-CBC cbcs mode (irrespective of CMAF)
Widevine and PlayReady support both AES-128 CTR cenc or AES-128 CBC cbcs modes.
MPEG-DASH with CMAF supports both AES-128 CTR cenc or AES-128 CBC cbcs modes.
MPEG-DASH without CMAF supports only AES-128 CTR cenc mode.
As you can see, the CMAF and CENC specs have lead to confusion and fragmentation in the streaming space.</p><p>A possible convergence point is the universal use of CMAF and AES-CBC cbcs mode, but, how will these impact legacy devices that support only CTR or only MPEG-TS?</p><p>That’s a discussion for another time.</p></blockquote><hr><p>分かりな疑問</p><blockquote><p>We’ve described a simple scheme, but there are many problems (technical and commercial) with our scheme. Here are some problems right off the bat.</p><p>We’ve described a prototypical “player” that sends a request for the decryption keys to the DRM License Server. But,
How does the license server know if the player is trustworthy?
And, what if the decryption software in the player exposes the key and the decrypted content?
Also, if you are a video player developer, do you have to develop decryption modules for every DRM technology? And, do you have to update it each time they make a change to their interfaces?
Furthermore, the sequence of events at the player (client-side) looks something like this –</p><ol><li>obtain the movie & its manifest from the CDN</li><li>extract the KeyID from the manifest</li><li>create the license request</li><li>send the license request to the license server</li><li>wait, listen, and receive the response from the license server.</li><li>use the decryption key from the server to decrypt the content</li><li>decode the decrypted content</li><li>display the decoded movie</li></ol><p>A single program or entity should NOT do all of the above.</p></blockquote><p>以下の2つに分ければいいらしい</p><ul><li>Player<ul><li>1, 2, 4, 5, (8 display これ安全じゃなさそう)</li></ul></li><li>CDM<ul><li>3(create Licence request), (understand the key), 6(decrypt), 7(decode)</li></ul></li></ul><a href=#cdmこれ大事><h3 id=cdmこれ大事><span class=hanchor arialabel=Anchor># </span>CDM(これ大事)</h3></a><blockquote><p>Every DRM provider provides its own</p><ol><li>mechanism to create a license request (using the KeyID, device identifier, signing the request, etc.)</li><li>mechanism to understand the license response received from the DRM License Server (the response is encrypted too) and extract the decryption key.</li><li>rules around storing the license locally on the client, license renewal, expiry, etc.</li></ol></blockquote><p>==browserにbuild-inでclosed-source==</p><a href=#eme><h3 id=eme><span class=hanchor arialabel=Anchor># </span>EME</h3></a><p><img src=https://md.trap.jp/uploads/upload_d6d10fe763ae69624a5057f9b1f37e00.png width=auto alt></p><hr><p>Q. 手元にある鍵はずっと使えそうだけど&mldr;？（「期限が切れたら自分のものでなくなる」というのをいかに実現しているか？）
A. バージョンバインディングの仕組み
バージョンを使って鍵の有効性を決めたい。普通の方法では古いバージョンのシステムの脆弱性だったりTEEの脆弱性があるとそれを使って有効にさせることができてしまう。そこでプロセスが起動する前にデバイスブートローダーがバージョン情報をTEE上で実行されているハードウェア格納型暗号サービスに渡し、鍵を生成する。アップグレード後は無効化するようにする。androidの記事より
キーストア=DRM Serverである？
他人が攻撃するときは完全に防げるけど自分のはブートローダーのレイヤーで攻撃すればいい話では（「正しく」実装されていることをなんらかの方法で証明できれば嬉しそう。しらんけど）
（TODO: 可能ということは分かったが、鍵の有効無効という概念があんまり理解できておらず）</p><p>Q. そもそもバージョンって何？なにのバージョン？
今回だとデバイスとOSのバージョンらしい??→OS等をアップデートしなければコンテンツを見続けられる&mldr;？（謎そう)</p><p>Q.有効なタイミングでdecryptedを保存するとかを防ぐのは別の仕組み？
A. :hi_UD::naruhodo:
encrypted+key(ネットワークを見ればいいからここは取れる。はず)->(ここにユーザーが介入できないようにする仕組みが必要)->view</p><hr><p>:eyes:
<img src=https://www.w3.org/TR/encrypted-media/stack_overview.svg width=auto alt>
<a href=https://www.w3.org/TR/encrypted-media/ rel=noopener>https://www.w3.org/TR/encrypted-media/</a></p><a href=#どうでもいい話><h3 id=どうでもいい話><span class=hanchor arialabel=Anchor># </span>どうでもいい話</h3></a><p>streaming protocols</p><ul><li><a href=https://linuxhit.com/rtmp-vs-hls-vs-dash-streaming-protocols/ rel=noopener>https://linuxhit.com/rtmp-vs-hls-vs-dash-streaming-protocols/</a></li><li><a href=https://youtube-eng.googleblog.com/2018/04/making-high-quality-video-efficient.html rel=noopener>https://youtube-eng.googleblog.com/2018/04/making-high-quality-video-efficient.html</a></li><li><a href=https://en.wikipedia.org/wiki/Adaptive_bitrate_streaming rel=noopener>https://en.wikipedia.org/wiki/Adaptive_bitrate_streaming</a><ul><li><a href=https://ottverse.com/what-is-abr-video-streaming/ rel=noopener>https://ottverse.com/what-is-abr-video-streaming/</a></li><li><a href=https://gist.github.com/voluntas/dd3af733825c7ae64505a1fd1bd0d684 rel=noopener>https://gist.github.com/voluntas/dd3af733825c7ae64505a1fd1bd0d684</a></li></ul></li></ul><a href=#todo><h2 id=todo><span class=hanchor arialabel=Anchor># </span>TODO</h2></a><p>暗号化や署名周りの具体的な実装（理論）
DRM Provider各社のエコシステム</p><a href=#refs><h2 id=refs><span class=hanchor arialabel=Anchor># </span>refs</h2></a><ul><li><a href=https://source.android.com/security/keystore rel=noopener>https://source.android.com/security/keystore</a></li><li><a href=https://developers.google.com/widevine/drm/overview rel=noopener>https://developers.google.com/widevine/drm/overview</a></li><li><a href=https://ottverse.com/eme-cenc-cdm-aes-keys-drm-digital-rights-management/ rel=noopener>https://ottverse.com/eme-cenc-cdm-aes-keys-drm-digital-rights-management/</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://anko9801.github.io/blog/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Jacky Zhao using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2022</p><ul><li><a href=https://anko9801.github.io/blog/>Home</a></li><li><a href=https://twitter.com/Anko_9801>Twitter</a></li><li><a href=https://github.com/anko9801>Github</a></li></ul></footer></div></div></body></html>