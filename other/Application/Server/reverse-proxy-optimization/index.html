<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="サーバー分割 DB分ける リクエストのロードバランス ロードバランサー セッションパーシステンス
worker_processesにそれぞれ均等にworker_connectionsが分配される訳ではないので余裕をもって設定すべき https://nrok81.hatenablog.com/entry/2014/11/12/191240
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130  worker_processesauto;# コア数と同じ数まで増やすと良いかも # nginx worker の設定 worker_rlimit_nofile4096;events{worker_connections1024;# 128より大きくするなら、 5_os にしたがって max connection 数を増やす必要あり（デフォルトで`net."><title>Nginx (リバースプロキシ)チューニング</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://anko9801.github.io/blog//icon.png><link href=https://anko9801.github.io/blog/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://anko9801.github.io/blog/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://anko9801.github.io/blog/js/darkmode.5777cdbea4ccb2b68cacc7e904cabb5c.min.js></script>
<script src=https://anko9801.github.io/blog/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://anko9801.github.io/blog/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://anko9801.github.io/blog/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://anko9801.github.io/blog/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://anko9801.github.io/blog/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://anko9801.github.io/blog/",fetchData=Promise.all([fetch("https://anko9801.github.io/blog/indices/linkIndex.dc57dd144d1792379e7d1b9270610429.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://anko9801.github.io/blog/indices/contentIndex.6d6f67da76386669a531ef52c0ed2927.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://anko9801.github.io/blog",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://anko9801.github.io/blog",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/anko9801.github.io\/blog\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script defer src=https://anko9801.github.io/blog/js/semantic-search.2c776550faf6cf14399b47e62a8e9782.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://anko9801.github.io/blog/>🪴 あやめHex</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Nginx (リバースプロキシ)チューニング</h1><p class=meta>Last updated
Oct 23, 2022
<a href=https://github.com/anko9801/blog/tree/hugo/content/other/Application/Server/reverse-proxy-optimization.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><ol><li><a href=#サーバー分割>サーバー分割</a></li><li><a href=#初期設定>初期設定</a></li></ol></li></ol></nav></details></aside><a href=#サーバー分割><h3 id=サーバー分割><span class=hanchor arialabel=Anchor># </span>サーバー分割</h3></a><p><strong>DB分ける</strong>
<strong>リクエストのロードバランス</strong>
ロードバランサー
セッションパーシステンス</p><p>worker_processesにそれぞれ均等にworker_connectionsが分配される訳ではないので余裕をもって設定すべき
<a href=https://nrok81.hatenablog.com/entry/2014/11/12/191240 rel=noopener>https://nrok81.hatenablog.com/entry/2014/11/12/191240</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>worker_processes</span><span class=w>  </span><span class=n>auto</span><span class=p>;</span><span class=w>  </span><span class=c1># コア数と同じ数まで増やすと良いかも
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1># nginx worker の設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>worker_rlimit_nofile</span><span class=w>  </span><span class=mi>4096</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>events</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>worker_connections</span><span class=w>  </span><span class=mi>1024</span><span class=p>;</span><span class=w>  </span><span class=c1># 128より大きくするなら、 5_os にしたがって max connection 数を増やす必要あり（デフォルトで`net.core.somaxconn` が 128 くらいで制限かけられてるので）。さらに大きくするなら worker_rlimit_nofile も大きくする（file descriptor数の制限を緩める)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># multi_accept on;         # error が出るリスクあり。defaultはoff。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># accept_mutex_delay 100ms;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>http</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log_format</span><span class=w> </span><span class=n>main</span><span class=w> </span><span class=s1>&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; $status $body_bytes_sent &#34;$http_referer&#34; &#34;$http_user_agent&#34; $request_time&#39;</span><span class=p>;</span><span class=w>   </span><span class=c1># kataribe 用の log format
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>access_log</span><span class=w>  </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>log</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>access</span><span class=p>.</span><span class=n>log</span><span class=w>  </span><span class=n>main</span><span class=p>;</span><span class=w>   </span><span class=c1># これはしばらく on にして、最後に off にすると良さそう。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># access_log  off;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># 基本設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>sendfile</span><span class=w>    </span><span class=k>on</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tcp_nopush</span><span class=w>  </span><span class=k>on</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tcp_nodelay</span><span class=w> </span><span class=k>on</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>types_hash_max_size</span><span class=w> </span><span class=mi>2048</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>server_tokens</span><span class=w>    </span><span class=n>off</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>open_file_cache</span><span class=w> </span><span class=n>max</span><span class=o>=</span><span class=mi>100</span><span class=w> </span><span class=n>inactive</span><span class=o>=</span><span class=mi>65</span><span class=n>s</span><span class=p>;</span><span class=w> </span><span class=c1># file descriptor のキャッシュ。入れた方が良い。 20s-&gt;65s
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># proxy buffer の設定。白金動物園が設定してた。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>proxy_buffers</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=mi>32</span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxy_buffer_size</span><span class=w> </span><span class=mi>8</span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># mime.type の設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>include</span><span class=w>       </span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>mime</span><span class=p>.</span><span class=n>types</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># Keepalive 設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># ベンチマークとの相性次第ではkeepalive off;にしたほうがいい
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># keepalive off;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># ベンチは1分しか回らない
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>keepalive_timeout</span><span class=w> </span><span class=mi>65</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>keepalive_requests</span><span class=w> </span><span class=mi>500</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># Proxy cache 設定。使いどころがあれば。1mでkey8,000個。1gまでcache。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>proxy_cache_path</span><span class=w> </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>cache</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>cache</span><span class=w> </span><span class=n>levels</span><span class=o>=</span><span class=mi>1</span><span class=p>:</span><span class=mi>2</span><span class=w> </span><span class=n>keys_zone</span><span class=o>=</span><span class=n>zone1</span><span class=p>:</span><span class=mi>1</span><span class=n>m</span><span class=w> </span><span class=n>max_size</span><span class=o>=</span><span class=mi>1</span><span class=n>g</span><span class=w> </span><span class=n>inactive</span><span class=o>=</span><span class=mi>1</span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxy_temp_path</span><span class=w>  </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>cache</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>tmp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># オリジンから来るCache-Controlを無視する必要があるなら。。。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>#proxy_ignore_headers Cache-Control;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># unix domain socket 設定1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>upstream</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>unix</span><span class=p>:</span><span class=o>/</span><span class=n>run</span><span class=o>/</span><span class=n>unicorn</span><span class=p>.</span><span class=n>sock</span><span class=p>;</span><span class=w>  </span><span class=c1># systemd を使ってると `/tmp` 以下が使えない。appのディレクトリに`tmp`ディレクトリ作って配置する方がpermissionでハマらずに済んで良いかも。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># 複数serverへ proxy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>upstream</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=mi>192</span><span class=p>.</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>1</span><span class=p>:</span><span class=mi>5000</span><span class=w> </span><span class=n>weight</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span><span class=w>  </span><span class=c1># weight をつけるとproxyする量を変更可能。defaultは1。多いほどたくさんrequestを振り分ける。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=mi>192</span><span class=p>.</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>2</span><span class=p>:</span><span class=mi>5000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=mi>192</span><span class=p>.</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>3</span><span class=p>:</span><span class=mi>5000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># keepalive 60;  # app server への connection を keepalive する。app が対応できるならした方が良い。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>server</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># reverse proxy の 設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=p>:</span><span class=mi>3000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># proxy_http_version 1.1;          # app server との connection を keepalive するなら追加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_set_header Connection &#34;&#34;;  # app server との connection を keepalive するなら追加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># Unix domain socket の設定2。設定1と組み合わせて。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># 簡易静的ファイルをNginx配信
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>root</span><span class=w> </span><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=k>user</span><span class=o>/</span><span class=n>app</span><span class=o>/</span><span class=n>public</span><span class=o>/</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>try_files</span><span class=w> </span><span class=err>$</span><span class=n>uri</span><span class=w> </span><span class=err>$</span><span class=n>uri</span><span class=o>/</span><span class=w> </span><span class=o>@</span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>@</span><span class=n>app</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># For Server Sent Event
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=n>api</span><span class=o>/</span><span class=n>stream</span><span class=o>/</span><span class=n>rooms</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># &#34;magic trio&#34; making EventSource working through Nginx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>proxy_http_version</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_set_header</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>chunked_transfer_encoding</span><span class=w> </span><span class=n>off</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># These are not an official way
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_buffering off;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_cache off;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=p>:</span><span class=mi>8080</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># For websocket
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=n>wsapp</span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_http_version</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_set_header</span><span class=w> </span><span class=n>Upgrade</span><span class=w> </span><span class=err>$</span><span class=n>http_upgrade</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_set_header</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=s2>&#34;upgrade&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>wsbackend</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># Proxy cache
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=n>cached</span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_cache</span><span class=w> </span><span class=n>zone1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># proxy_set_header X-Real-IP $remote_addr;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_set_header Host $http_host;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=p>:</span><span class=mi>9292</span><span class=o>/</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># デフォルトでは 200, 301, 302 だけキャッシュされる。proxy_cache_valid で増やせる。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_cache_valid 200 301 302 3s;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># cookie を key に含めることもできる。デフォルトは $scheme$proxy_host$request_uri;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_cache_key $proxy_host$request_uri$cookie_jessionid;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># レスポンスヘッダにキャッシュヒットしたかどうかを含める
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>add_header</span><span class=w> </span><span class=n>X</span><span class=o>-</span><span class=n>Nginx</span><span class=o>-</span><span class=n>Cache</span><span class=w> </span><span class=err>$</span><span class=n>upstream_cache_status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># static file の配信用の root
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>root</span><span class=w> </span><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>isucon</span><span class=o>/</span><span class=n>webapp</span><span class=o>/</span><span class=n>public</span><span class=o>/</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>~</span><span class=w> </span><span class=p>.</span><span class=o>*</span><span class=err>\</span><span class=p>.(</span><span class=n>htm</span><span class=o>|</span><span class=n>html</span><span class=o>|</span><span class=n>css</span><span class=o>|</span><span class=n>js</span><span class=o>|</span><span class=n>jpg</span><span class=o>|</span><span class=n>png</span><span class=o>|</span><span class=n>gif</span><span class=o>|</span><span class=n>ico</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>expires</span><span class=w> </span><span class=mi>24</span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>add_header</span><span class=w> </span><span class=n>Cache</span><span class=o>-</span><span class=n>Control</span><span class=w> </span><span class=n>public</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>open_file_cache</span><span class=w> </span><span class=n>max</span><span class=o>=</span><span class=mi>100</span><span class=p>;</span><span class=w>  </span><span class=c1># file descriptor などを cache
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>gzip</span><span class=w> </span><span class=k>on</span><span class=p>;</span><span class=w>  </span><span class=c1># cpu 使うのでメリット・デメリット見極める必要あり。gzip_static 使えるなら事前にgzip圧縮した上でそちらを使う。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>gzip_types</span><span class=w> </span><span class=kt>text</span><span class=o>/</span><span class=n>html</span><span class=w> </span><span class=kt>text</span><span class=o>/</span><span class=n>css</span><span class=w> </span><span class=n>application</span><span class=o>/</span><span class=n>javascript</span><span class=w> </span><span class=n>application</span><span class=o>/</span><span class=n>json</span><span class=w> </span><span class=n>font</span><span class=o>/</span><span class=n>woff</span><span class=w> </span><span class=n>font</span><span class=o>/</span><span class=n>ttf</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>gif</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>png</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>jpeg</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>svg</span><span class=o>+</span><span class=n>xml</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>x</span><span class=o>-</span><span class=n>icon</span><span class=w> </span><span class=n>application</span><span class=o>/</span><span class=n>octet</span><span class=o>-</span><span class=n>stream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>gzip_disable</span><span class=w> </span><span class=s2>&#34;msie6&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>gzip_static</span><span class=w> </span><span class=k>on</span><span class=p>;</span><span class=w>  </span><span class=c1># nginx configure時に --with-http_gzip_static_module 必要
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>user www-data;
</span></span><span class=line><span class=cl>pid /run/nginx.pid;
</span></span><span class=line><span class=cl>include /etc/nginx/modules-enabled/*.conf;
</span></span><span class=line><span class=cl>worker_rlimit_nofile 100000;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>error_log  /var/log/nginx/error.log error;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>http {
</span></span><span class=line><span class=cl>    default_type  application/octet-stream;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    client_max_body_size 10m;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # TLS configuration
</span></span><span class=line><span class=cl>    ssl_protocols TLSv1.2;
</span></span><span class=line><span class=cl>    ssl_prefer_server_ciphers on;
</span></span><span class=line><span class=cl>    ssl_ciphers &#39;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384&#39;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	server {
</span></span><span class=line><span class=cl>	    listen 443 ssl http2;
</span></span><span class=line><span class=cl>	    server_name isucon9.catatsuy.org;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	    ssl_certificate /etc/nginx/ssl/fullchain.pem;
</span></span><span class=line><span class=cl>	    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		root /home/isucon/isucari/webapp/public;
</span></span><span class=line><span class=cl>		location /static/ {
</span></span><span class=line><span class=cl>			add_header Cache-Control &#34;public max-age=86400&#34;;
</span></span><span class=line><span class=cl>		}
</span></span><span class=line><span class=cl>		location /upload/ {
</span></span><span class=line><span class=cl>			add_header Cache-Control &#34;public max-age=86400&#34;;
</span></span><span class=line><span class=cl>		}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	    location / {
</span></span><span class=line><span class=cl>		proxy_pass http://app;
</span></span><span class=line><span class=cl>		proxy_set_header Host $host;
</span></span><span class=line><span class=cl>	    }
</span></span><span class=line><span class=cl>	    location /login {
</span></span><span class=line><span class=cl>		proxy_pass http://login_app;
</span></span><span class=line><span class=cl>		proxy_set_header Host $host;
</span></span><span class=line><span class=cl>	    }
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#初期設定><h3 id=初期設定><span class=hanchor arialabel=Anchor># </span>初期設定</h3></a><p><a href=https://wiki.trap.jp/user/to-hutohu/memo/ISUCON%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88 rel=noopener>https://wiki.trap.jp/user/to-hutohu/memo/ISUCON%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88</a></p><a href=#os><h4 id=os><span class=hanchor arialabel=Anchor># </span>OS</h4></a><p>設定したら<code>sudo sysctl -p {{filename}}</code>で反映する
実行中のプロセスには反映されないからプロセスの再起動が必要</p><p>備考: <code>net.ipv4.ip_, net.ipv4.ip_local_portrange, net.ipv4.tcp, net.ipv4.icmp_*</code>はipv6にも適用される</p><a href=#nginx><h4 id=nginx><span class=hanchor arialabel=Anchor># </span>nginx</h4></a><p><code>$ sudo cp *.conf *.conf.bk</code>
<code>/etc/nginx/nginx.conf</code>
<code>/etc/nginx/sites-enabled/*.conf</code> (ここでは<code>http</code>ブロック内しか変更できない)
<code>/etc/nginx/sites-available/*.conf</code>に書いて↑ではエイリアスを貼るのが正解
<a href=https://wiki.trap.jp/user/to-hutohu/memo/ISUCON%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88#head10 rel=noopener>https://wiki.trap.jp/user/to-hutohu/memo/ISUCON%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88#head10</a></p><p>nginxとアプリケーションの間をunix domain socket
<code>Unix domain socket</code>は後回し
<a href=https://qiita.com/ihsiek/items/11106ce7a13e09b61547#web%E3%82%B5%E3%83%BC%E3%83%90 rel=noopener>https://qiita.com/ihsiek/items/11106ce7a13e09b61547#web%E3%82%B5%E3%83%BC%E3%83%90</a>
<code>index.html</code>を配信してるところをnginxで返すようにする</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    # index.htmlの配信
</span></span><span class=line><span class=cl>    location ~ ^/(?:login|register|timeline|categories|sell|items|buy/complete|transactions|users)(?!.*.(?:json|png)) {
</span></span><span class=line><span class=cl>        try_files $uri /index.html;
</span></span><span class=line><span class=cl>    }
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>server {
</span></span><span class=line><span class=cl>    listen       80 default_server;
</span></span><span class=line><span class=cl>    server_name  _;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location / {
</span></span><span class=line><span class=cl>         root /home/isucon/torb/webapp/static/;
</span></span><span class=line><span class=cl>         try_files $uri $uri/ @app;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location @app {
</span></span><span class=line><span class=cl>        proxy_set_header Host $host;
</span></span><span class=line><span class=cl>        proxy_pass   http://127.0.0.1:8080;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    proxy_buffer_size 128k;
</span></span><span class=line><span class=cl>    proxy_buffers 32 128k;
</span></span><span class=line><span class=cl>    proxy_busy_buffers_size 128k;
</span></span></code></pre></td></tr></table></div></div><p>h2cの有効化(意味なさそうなのでhttpsを使ってhttp2を使うべき)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>server {
</span></span><span class=line><span class=cl>    listen 80 http2;
</span></span></code></pre></td></tr></table></div></div><h5 id=heading></h5><p>設定</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>worker_processes auto;
</span></span><span class=line><span class=cl>worker_rlimit_nofile 4096;
</span></span><span class=line><span class=cl>events {
</span></span><span class=line><span class=cl>    worker_connections 1024; # net.core.somaxconnとworker_rlimit_nofileも大きくする
</span></span><span class=line><span class=cl>    #multi_accept on; # error が出るリスクあり。defaultはoff
</span></span><span class=line><span class=cl>    #accept_mutex_delay 100ms;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>nginx の worker_connections は worker 当たりの同時接続数だと思ってたけどどうも違うっぽい
<a href=https://nrok81.hatenablog.com/entry/2014/11/12/191240 rel=noopener>https://nrok81.hatenablog.com/entry/2014/11/12/191240</a></p><a href=#ログ設定-httpディレクティブの中><h5 id=ログ設定-httpディレクティブの中><span class=hanchor arialabel=Anchor># </span>ログ設定 httpディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>log_format main &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; $status $body_bytes_sent &#34;$http_referer&#34; &#34;$http_user_agent&#34; $request_time&#39;;
</span></span><span class=line><span class=cl>access_log /tmp/access.log main;
</span></span><span class=line><span class=cl>#access_log off;
</span></span></code></pre></td></tr></table></div></div><a href=#基本設定-httpディレクティブの中><h5 id=基本設定-httpディレクティブの中><span class=hanchor arialabel=Anchor># </span>基本設定 httpディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sendfile on;
</span></span><span class=line><span class=cl>tcp_nopush on;
</span></span><span class=line><span class=cl>tcp_nodelay on;
</span></span><span class=line><span class=cl>types_hash_max_size 2048;
</span></span><span class=line><span class=cl>server_tokens off;
</span></span><span class=line><span class=cl>open_file_cache max=100 inactive=20s; # file descriptorのキャッシュ
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># proxy bufferの設定
</span></span><span class=line><span class=cl>proxy_buffers 100 32k;
</span></span><span class=line><span class=cl>proxy_buffer_size 8k;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># keepaliveの設定
</span></span><span class=line><span class=cl>#keepalive off; # ベンチマークとの相性次第ではoffにしたほうがいい
</span></span><span class=line><span class=cl>keepalive_timeout 120;
</span></span><span class=line><span class=cl>keepalive_requests 1048576;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># proxy cacheの設定
</span></span><span class=line><span class=cl>proxy_cache_path /var/cache/nginx/cache levels=1:2 keys_zone=zone1:1m max_size=1g inactive=1h;
</span></span><span class=line><span class=cl>proxy_temp_path  /var/cache/nginx/tmp;
</span></span><span class=line><span class=cl>#proxy_ignore_headers Cache-Control; # upstreamから来るCache-Controlを無視する必要があるなら
</span></span></code></pre></td></tr></table></div></div><a href=#upstream設定-httpディレクティブの中><h5 id=upstream設定-httpディレクティブの中><span class=hanchor arialabel=Anchor># </span>upstream設定 httpディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>upstream app {
</span></span><span class=line><span class=cl>    server 127.0.0.1:8000;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    keepalive 256;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#reverse-proxy設定-serverディレクティブの中><h5 id=reverse-proxy設定-serverディレクティブの中><span class=hanchor arialabel=Anchor># </span>reverse proxy設定 serverディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>location /initialize {
</span></span><span class=line><span class=cl>    proxy_http_version 1.1;
</span></span><span class=line><span class=cl>    proxy_set_header Connection &#34;&#34;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    proxy_read_timeout 120;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    #proxy_cache zone1;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    proxy_set_header Host $host;
</span></span><span class=line><span class=cl>    proxy_set_header X-Real-IP $remote_addr;
</span></span><span class=line><span class=cl>    proxy_set_header X-Forwarded-Proto $scheme;
</span></span><span class=line><span class=cl>    proxy_set_header X-Forwarded-Host $host;
</span></span><span class=line><span class=cl>    proxy_set_header X-Forwarded-Server $host;
</span></span><span class=line><span class=cl>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    proxy_pass http://app;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#静的配信設定-serverディレクティブの中><h5 id=静的配信設定-serverディレクティブの中><span class=hanchor arialabel=Anchor># </span>静的配信設定 serverディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># static file の配信用の root
</span></span><span class=line><span class=cl>root /home/isucon/webapp/public/;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>location ~ .*\.(htm|html|css|js|eot|svg|ttf|woff|woff2|gif|jpg|png|ico) {
</span></span><span class=line><span class=cl>    expires 24h;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    gzip off;
</span></span><span class=line><span class=cl>    #gzip on; # CPUを使うのでメリット・デメリット見極める必要あり。gzip_staticが使えるなら事前にgzip圧縮した上でそちらを使う
</span></span><span class=line><span class=cl>    #gzip_types *;
</span></span><span class=line><span class=cl>    #gzip_disable &#34;msie6&#34;;
</span></span><span class=line><span class=cl>    #gzip_static on;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#gzip><h5 id=gzip><span class=hanchor arialabel=Anchor># </span>gzip</h5></a><ul><li>できればgzip_staticを使う<ul><li>圧縮コマンド <code>find ./* | xargs -I {} sh -c 'gzip -9 -v -N -c {} > {}.gz'</code><ul><li>元のファイルを残して圧縮する</li></ul></li></ul></li></ul><hr></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://anko9801.github.io/blog/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Jacky Zhao using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2022</p><ul><li><a href=https://anko9801.github.io/blog/>Home</a></li><li><a href=https://twitter.com/Anko_9801>Twitter</a></li><li><a href=https://github.com/anko9801>Github</a></li></ul></footer></div></div></body></html>