<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Cache
Copy on Write An Overview of Query Optimization in Relational Systems 論文紹介 - Google スライド
O/R Mapper
ISUCONメモ  https://github."><title>バックエンド最適化</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://anko9801.github.io/blog//icon.png><link href=https://anko9801.github.io/blog/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://anko9801.github.io/blog/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://anko9801.github.io/blog/js/darkmode.5777cdbea4ccb2b68cacc7e904cabb5c.min.js></script>
<script src=https://anko9801.github.io/blog/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://anko9801.github.io/blog/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://anko9801.github.io/blog/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://anko9801.github.io/blog/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://anko9801.github.io/blog/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://anko9801.github.io/blog/",fetchData=Promise.all([fetch("https://anko9801.github.io/blog/indices/linkIndex.dfa47283aa715e6981de12ca87ce272e.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://anko9801.github.io/blog/indices/contentIndex.16cb28114ea2da1c108a85d8d5cb9f4b.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://anko9801.github.io/blog",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://anko9801.github.io/blog",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/anko9801.github.io\/blog\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://anko9801.github.io/blog/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://anko9801.github.io/blog/>🪴 あやめHex</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>バックエンド最適化</h1><p class=meta>Last updated
Oct 23, 2022
<a href=https://github.com/anko9801/blog/tree/hugo/content/other/Application/Server/backend-optimization.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#事前講習>事前講習</a><ol><li><a href=#開始直後>開始直後</a></li></ol></li><li><a href=#各種解析ツール-推測するな計測せよ>各種解析ツール 推測するな計測せよ</a><ol><li><a href=#パフォーマンスモニタリング>パフォーマンスモニタリング</a></li><li><a href=#メトリクス>メトリクス</a></li><li><a href=#アクセス解析>アクセス解析</a></li><li><a href=#プロファイリング>プロファイリング</a></li><li><a href=#スロークエリ>スロークエリ</a></li><li><a href=#sql全般>SQL全般</a></li><li><a href=#makefile>Makefile</a></li></ol></li><li><a href=#アプリ>アプリ</a><ol><li><a href=#プロファイラの設定>プロファイラの設定</a></li></ol></li><li><a href=#mysql-チューニング>MySQL チューニング</a><ol><li><a href=#データベースとは>データベースとは</a></li><li><a href=#具体的にどんな処理がされているのか>具体的にどんな処理がされているのか</a></li><li><a href=#collation照合順序>Collation(照合順序)</a></li><li><a href=#トランザクション>トランザクション</a></li><li><a href=#preparedstatement>PreparedStatement</a></li><li><a href=#生成カラムgenerated-column>生成カラム(generated column)</a></li><li><a href=#メモリ最適化>メモリ最適化</a></li><li><a href=#キーキャッシュ>キーキャッシュ</a></li><li><a href=#orm-orマッパー>ORM O/Rマッパー</a></li><li><a href=#mysql設定>MySQL設定</a></li><li><a href=#スロークエリ-1>スロークエリ</a></li><li><a href=#クエリーキャッシュ-qcache>クエリーキャッシュ Qcache</a></li><li><a href=#再起試験対策>再起試験対策</a></li><li><a href=#json>JSON</a></li></ol></li><li><a href=#http-チューニング>HTTP チューニング</a></li><li><a href=#カーネルパラメータ-チューニング>カーネルパラメータ チューニング</a><ol><li><a href=#ファイルディスクリプタの上限>ファイルディスクリプタの上限</a></li><li><a href=#カーネルパラメータ>カーネルパラメータ</a></li></ol></li><li><a href=#nginx-リバースプロキシチューニング>Nginx (リバースプロキシ)チューニング</a><ol><li><a href=#サーバー分割>サーバー分割</a></li><li><a href=#初期設定>初期設定</a></li><li><a href=#メモ>メモ</a></li></ol></li></ol></nav></details></aside><p>Cache</p><p>Copy on Write
<a href="https://docs.google.com/presentation/d/1ruGYLRLeagkfv1gQBlmh_di7AviaSx0MJih4oH24AsY/edit#slide=id.p" rel=noopener>An Overview of Query Optimization in Relational Systems 論文紹介 - Google スライド</a></p><p>O/R Mapper</p><a href=#isuconメモ><h1 id=isuconメモ><span class=hanchor arialabel=Anchor># </span>ISUCONメモ</h1></a><p><a href=https://github.com/FujishigeTemma/isucon9-qualify/blob/master/go/main.go rel=noopener>https://github.com/FujishigeTemma/isucon9-qualify/blob/master/go/main.go</a>
<a href=https://github.com/tohutohu/isucon9/blob/master/webapp/go/main.go rel=noopener>https://github.com/tohutohu/isucon9/blob/master/webapp/go/main.go</a></p><p><a href="https://www.youtube.com/watch?v=0DhBLswwcRs" rel=noopener>https://www.youtube.com/watch?v=0DhBLswwcRs</a></p><p><a href=https://gist.github.com/941/8c64842b71995a2d448315e2594f62c2 rel=noopener>https://gist.github.com/941/8c64842b71995a2d448315e2594f62c2</a>
<a href=https://gist.github.com/south37/d4a5a8158f49e067237c17d13ecab12a rel=noopener>https://gist.github.com/south37/d4a5a8158f49e067237c17d13ecab12a</a>
<a href=https://isucon.net/archives/54822761.html rel=noopener>https://isucon.net/archives/54822761.html</a></p><a href=#事前講習><h2 id=事前講習><span class=hanchor arialabel=Anchor># </span>事前講習</h2></a><p>工事中
:::spoiler
ssh接続
ssh鍵
githubで公開リポジトリに置くと失格
マニュアルを全員読む(情報をまとめることが得意な人がいたら)
初期ベンチ
ベンチの振れ幅、挙動を調べる
1コミット1ベンチ
コミットコメントにログとか載せると良き
キャッシュが必要以上に残るとフェイル
タイムアウトか間違ったキャッシュならタイムアウトを取る</p><p>変更するファイル
webapp/go
webapp/sql
各種設定ファイル
nginxやmysqlの設定などはgit内に移して元の場所にシンボリックリンクを貼る</p><a href=#開始直後><h3 id=開始直後><span class=hanchor arialabel=Anchor># </span>開始直後</h3></a><p>マニュアルを全員で読む</p><ul><li>点数に関わる記述が重要情報</li><li>キャッシュの許され方<ul><li>「N秒キャッシュしてもよい」と書いてある</li></ul></li></ul><p>不要なデーモンを止める</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cat /proc/cpuinfo
</span></span><span class=line><span class=cl>free -h
</span></span><span class=line><span class=cl>systemctl list-units --type=service --state=running
</span></span></code></pre></td></tr></table></div></div><p>ssh configの設定
ベンチ1回目
リポジトリ内にシンボリックリンクを置く
git init git remote git add . git commit -m &ldquo;Initial commit&rdquo;
お昼食べる
利用するサイトの動作確認
忘れて無ければ全ページのスクショを撮る
ラストのチェックのときにCSSとかをざっと見る
使いそうなファイル群を固めてローカルに持ってくる
tar xvcf webapp
scp user@ip:~/webapp.tar .
更新箇所のチェック
エンドポイントの数
更新があるエンドポイント
mysqlとnginxのログ設定
解析ツールのインストール
ベンチ2回目
秘伝のタレ
ベンチ3回目</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>INDEX idx_category_id_created_at (category_id,created_at),
</span></span><span class=line><span class=cl>INDEX idx_created_at (created_at),
</span></span><span class=line><span class=cl>INDEX idx_buyer_id (buyer_id),
</span></span><span class=line><span class=cl>INDEX mul_idx_seller_id_created_at (seller_id, created_at)
</span></span></code></pre></td></tr></table></div></div><p><a href=https://github.com/reyu0722/piscon2021 rel=noopener>https://github.com/reyu0722/piscon2021</a></p><ul><li>ItemとかUserとかで取れる部分はキャッシュする -> 71500</li><li>Item以外をメモリだけで管理するようにした (他にもいくつか) -> 87840<ul><li>超大変だった
:::</li></ul></li></ul><a href=#各種解析ツール-推測するな計測せよ><h2 id=各種解析ツール-推測するな計測せよ><span class=hanchor arialabel=Anchor># </span>各種解析ツール 推測するな計測せよ</h2></a><a href=#パフォーマンスモニタリング><h3 id=パフォーマンスモニタリング><span class=hanchor arialabel=Anchor># </span>パフォーマンスモニタリング</h3></a><p>CPU占有率の高いプロセスを特定します
htop dstat
dstat -tlamp</p><a href=#メトリクス><h3 id=メトリクス><span class=hanchor arialabel=Anchor># </span>メトリクス</h3></a><p>高級なパフォーマンスモニタリングツール
<a href=https://github.com/netdata/netdata rel=noopener>netdata</a> NewRelic Splunk
<a href=https://dev.classmethod.jp/articles/netdata/ rel=noopener>https://dev.classmethod.jp/articles/netdata/</a></p><a href=#アクセス解析><h3 id=アクセス解析><span class=hanchor arialabel=Anchor># </span>アクセス解析</h3></a><p>パスパラメータ/クエリパラメータ別のアクセス数を表示してくれます
主に見るべきはavg 次にcount
kataribe <strong><a href=https://github.com/tkuchiki/alp rel=noopener>alp</a></strong></p><a href=#プロファイリング><h3 id=プロファイリング><span class=hanchor arialabel=Anchor># </span>プロファイリング</h3></a><p><strong>pprof</strong> fgprof</p><a href=#スロークエリ><h3 id=スロークエリ><span class=hanchor arialabel=Anchor># </span>スロークエリ</h3></a><p>mysqldumpslow <strong>pt-query-digest</strong></p><a href=#sql全般><h3 id=sql全般><span class=hanchor arialabel=Anchor># </span>SQL全般</h3></a><p><strong><a href=https://www.s-style.co.jp/products/percona/toolkit rel=noopener>percona tool kit</a></strong>
<a href=https://github.com/major/MySQLTuner-perl rel=noopener>mysqltuner</a></p><a href=#makefile><h3 id=makefile><span class=hanchor arialabel=Anchor># </span>Makefile</h3></a><p>TODO: 秘伝のMakefileを作る
<a href=https://gist.github.com/azonti/dee0547cb561dfdec4a90e093a418bdc rel=noopener>https://gist.github.com/azonti/dee0547cb561dfdec4a90e093a418bdc</a>
<a href=https://github.com/FujishigeTemma/isucon10-final/blob/master/Makefile rel=noopener>https://github.com/FujishigeTemma/isucon10-final/blob/master/Makefile</a>
<a href=https://github.com/tohutohu/isucon9/blob/master/Makefile rel=noopener>https://github.com/tohutohu/isucon9/blob/master/Makefile</a>
<a href=https://git.trap.jp/eiya/202008piscon/src/branch/master/go/Makefile rel=noopener>https://git.trap.jp/eiya/202008piscon/src/branch/master/go/Makefile</a></p><a href=#アプリ><h2 id=アプリ><span class=hanchor arialabel=Anchor># </span>アプリ</h2></a><ul><li>クエリ最適化</li><li>変更の少ないデータのキャッシュ化</li><li>やらなくてよい処理を省く</li><li>強いセキュリティを弱くして高速化(gorilla/sessions->自前実装 net/http->fasthttp bcrypt->SHA256など)</li><li>APIの並列化</li><li>FOR UPDATEアプリケーションで排他制御</li><li>gollira/sessionはセキュアなセッションをcookieだけで実現しているので、暗号化のコストが結構かかる -> ランダムな値とmapを使った実装に差し替え</li><li>jsonのエンコード/デコードをgo-json</li></ul><a href=#プロファイラの設定><h3 id=プロファイラの設定><span class=hanchor arialabel=Anchor># </span>プロファイラの設定</h3></a><h4 id=pprof-httpsgithubcomgooglepprof>pprof
<a href=https://github.com/google/pprof rel=noopener>https://github.com/google/pprof</a></h4><p>標準で入っているプロファイラです。デファクトスタンダードという感じ。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=nx>_</span> <span class=err>&#39;</span><span class=nx>net</span><span class=o>/</span><span class=nx>http</span><span class=o>/</span><span class=nx>pprof</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:6060&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// &lt;code to profile&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>プロファイリングした画像をdiscordやslackに届けるシェルです。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>go tool pprof -png -output pprof.png http://localhost:6060/debug/pprof/profile?seconds<span class=o>=</span><span class=m>60</span>
</span></span><span class=line><span class=cl>curl -X POST -F <span class=nv>img</span><span class=o>=</span>@pprof.png <span class=k>$(</span>DISCORD_WEBHOOK_URL<span class=k>)</span>
</span></span><span class=line><span class=cl>slackcat --channel general pprof.png
</span></span></code></pre></td></tr></table></div></div><h4 id=fgprof-httpsgithubcomfelixgefgprof>fgprof
<a href=https://github.com/felixge/fgprof rel=noopener>https://github.com/felixge/fgprof</a></h4><p>一部適切な表示とならないことがある</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;net/http/pprof&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/felixge/fgprof&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>http</span><span class=p>.</span><span class=nx>DefaultServeMux</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/debug/fgprof&#34;</span><span class=p>,</span> <span class=nx>fgprof</span><span class=p>.</span><span class=nf>Handler</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:6060&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// &lt;code to profile&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>http://localhost:6060/debug/fgprof</code></p><a href=#mysql-チューニング><h2 id=mysql-チューニング><span class=hanchor arialabel=Anchor># </span>MySQL チューニング</h2></a><a href=#データベースとは><h3 id=データベースとは><span class=hanchor arialabel=Anchor># </span>データベースとは</h3></a><ul><li><a href=https://qiita.com/kiyodori/items/f66a545a47dc59dd8839 rel=noopener>B-Tree/B+Tree</a>LSMツリーと呼ばれる平衡N分木で構築されたデータの集合。メモリ/実行時間最適化、排他制御をよしなにやってくれます。</li><li>やり取りに人間がわかりやすい言葉<code>DDL(Data Definition Language) DML(Data Manipulation Language) DCL(Data Control Language)</code>を使ってDBを操作します。例えば<code>Structured Query Language(SQL)</code>などがあります。</li><li>データベースシステムとSQLはごっちゃにして言われやすいので注意。例えば、MariaDBはMySQLから派生した<code>Relational Database Management System(RDBMS)</code>の一種だとか、<code>Not only SQL(NoSQL)</code>はクラウドのDBに対してネットワーク伝送コストを避けて最適化された非RDBMSで、MongoDBやAWSのDynamoDB, Redisがそれに含まるなど。</li></ul><a href=#具体的にどんな処理がされているのか><h3 id=具体的にどんな処理がされているのか><span class=hanchor arialabel=Anchor># </span>具体的にどんな処理がされているのか</h3></a><p>工事中
:::spoiler
<a href=https://zenn.dev/tzkoba/articles/bb6d31d46be8b3 rel=noopener>https://zenn.dev/tzkoba/articles/bb6d31d46be8b3</a></p><p>コネクションプール
クエリパーサ
クエリーキャッシュ
クエリプランナー
クエリエクスキュータ
アクセスメソッド
バッファプールマネージャ = ストレージエンジン?
ディスクマネージャ</p><p><a href=https://qiita.com/k_0120/items/a27ea1fc3b9bddc77fa1 rel=noopener>実行順序</a>
FROM句
JOIN句
WHERE句
GROUP BY句
HAVING句
SELECT句
ORDER BY句
LIMIT句</p><p>アクセスメソッドCRUD</p><p>memcached
Redis</p><p>レプリケーション</p><p>テンポラリーテーブル</p><p>クラッシュリカバリ
Redundant Array of Independent Disks
RAID 0・RAID 1・RAID 5、およびこれら3方式の組み合わせが用いられている。後にRAID 5を拡張したRAID 6が定義され、RAID 5より耐障害性が必要な場面で利用されている。
二重書き込みバッファー
トランザクションログ</p><p>クラスタデータベース
セカンダリインデックス
キー　セカンダリキー　バリュー　プライマリーキー
クラスタードインデックス
テーブルをB+Treeに入れる</p><p>Memcomparable format</p><p><a href=https://qiita.com/yoan/items/ba62dd65b24ac1b6a458 rel=noopener>ProxySQL</a></p><p>シリアル　数字の羅列
シーケンス　順番に並ぶ数字列</p><p>負荷分散技術
水平分割(シャーディング)　レコード単位で分割
垂直分割　カラム単位で分割</p><p>ワークラウンド　回避策
ワークロード　仕事量</p><p>ストレージエンジン
データ変換
インデックス
メモリ利用
トランザクション
同時実行性(排他制御)
ユニークファンクション（MyISAMの空間情報インデックスなど）
innoDB : MySQLでもっとも汎用のストレージエンジン</p><p>ACID
A: 原子性
C: 一貫性
I: 分離性
D: 持続性</p><p>MySQL InnoDB memcached Plugin
<a href=https://qiita.com/hypermkt/items/ccfb47e69c4a6a3ce09a rel=noopener>https://qiita.com/hypermkt/items/ccfb47e69c4a6a3ce09a</a>
プラグインって何のプラグイン？
これってmemcachedと何が違うの</p><p>MEMORY ストレージエンジン
<a href=https://dev.mysql.com/doc/refman/5.6/ja/memory-storage-engine.html rel=noopener>https://dev.mysql.com/doc/refman/5.6/ja/memory-storage-engine.html</a>
ストレージエンジンをMEMORYにするのはかなり注意が必要(NaruseJunがそれでメモリ使い果たして鯖爆破していたはず)</p><p>INVISIBLE COLUMNS *でとりだされない
INSERT RETURNING
FOREIGN KEY
<a href=https://www.dbonline.jp/mysql/table/index11.html rel=noopener>https://www.dbonline.jp/mysql/table/index11.html</a>
:::</p><a href=#collation照合順序><h3 id=collation照合順序><span class=hanchor arialabel=Anchor># </span>Collation(照合順序)</h3></a><p>文字列をどうエンコーディングしてB+ツリーにどうソートして突っ込むかを設定できます。DB単位、テーブル単位、カラム単位で設定可能。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>utf8mb4_test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>utf8mb4_test</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=w> </span><span class=kt>int</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=no>NULL</span><span class=w> </span><span class=kp>AUTO_INCREMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>str</span><span class=o>`</span><span class=w> </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span><span class=w> </span><span class=k>COLLATE</span><span class=w> </span><span class=n>utf8mb4_bin</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=no>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>KEY</span><span class=w> </span><span class=o>`</span><span class=n>str</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>str</span><span class=o>`</span><span class=p>(</span><span class=mi>767</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=kp>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=kp>CHARSET</span><span class=o>=</span><span class=n>utf8mb4</span><span class=w> </span><span class=k>COLLATE</span><span class=o>=</span><span class=n>utf8mb4_bin</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>文字コード_言語名_比較法</code></p><a href=#文字コードcharacter-set><h4 id=文字コードcharacter-set><span class=hanchor arialabel=Anchor># </span>文字コード(Character Set)</h4></a><p>utf8とかeucとかが入ります。
cp932やbig5などは危険なエンコーディングらしい(しらんけど)</p><p>conoHaがこれでやらかしていたらしい
traP SysAd TechBook より
データベースメンテナンスで⼤わらわ！</p><p>2019年8⽉6⽇夜 ConoHaのマネージドDBでメンテナンスがありました。SysAd班で
はメンテナンスの存在を知らず、急にtraQなどが機能しなくなったため⼀瞬混乱が起き
ました。しかしその後すぐ、@takashi_trapがメンテナンスであることをアナウンスし混乱
は収束しました。
しかし、本当の混乱はメンテナンス後に発⽣したのです。traQの復旧によりメンバー
がtraQに戻ってきたのですが、下のような投稿がいろんなチャンネルで出始めたので
す。
図2.6: 表⽰名が壊れたメンバーの投稿（修正後スクリーンショットを撮った）
その後すべてのサービスのデータを確認してみると、すべてのサービスで⼀部の絵⽂
字データが破損していることが確認されました。班内で検討したところ、おそらく「寿司ビ
ール問題」として有名な、utf8mb4のデータをutf8として扱ってしまったことによる4バイト
⽂字の破損であるだろうという結論に⾄りました。
ConoHaに問い合わせてみましたが、私達の推測通りメンテナンスではマシンの⼊れ
替えのためにデータのバックアップを⾏なっており、その際にutf8でバックアップを取っ
たとのこと。ConoHa側が持っている完全なバックアップは2⽉時点のものでそれ以降の
データを復旧することは不可能であると回答がありました*3。外部に公開されている
Blogサービスのみ、たまたま2週間ほど前にBlogサービスのバージョンアップ検証を⾏
うために取っていたバックアップから差分を復旧することで対処しました。
まさかこんなことってあるんですねぇ……となった事件でした</p><a href=#言語名><h4 id=言語名><span class=hanchor arialabel=Anchor># </span>言語名</h4></a><p>japaneseやthaiやgeneral、unicodeなどが入ります。
generalやunicodeはマルチリンガルの事(utf8にjapaneseはない)。</p><a href=#比較法><h4 id=比較法><span class=hanchor arialabel=Anchor># </span>比較法</h4></a><p><code>_ci _cs _bin</code>のいずれか(で終わる)</p><p>_ci: 大文字と小文字が区別されない
_cs: 大文字と小文字が区別される
_bin: バイナリ</p><a href=#utf8_general_ciとutf8_unicode_ciの使い分け><h4 id=utf8_general_ciとutf8_unicode_ciの使い分け><span class=hanchor arialabel=Anchor># </span>utf8_general_ciとutf8_unicode_ciの使い分け</h4></a><p>unicode の方はあいまいな照合が可能です。全角、半角、大文字、小文字を無視して一致するものを検索できます。</p><p>たとえば、検索文字に<code>MySQL</code>を指定した時と、<code>ｍｙｓｑｌ</code>を指定した時の検索結果は同じになります。</p><p>general の方はその逆で、厳密に違いとして認識され先の例の検索結果は異なります。</p><p>どちらも項目の用途によって使い分けるのが、あるべき姿なのでは無いかと思います。</p><p><code>utf8mb4_bin</code>のが<code>utf8mb4_general_ci</code>より少しはやいらしい
<a href=https://yakst.com/ja/posts/5431 rel=noopener>https://yakst.com/ja/posts/5431</a>
MySQL8なら<code>utf8mb4_0900_bin</code>を試してみる
<a href=https://qiita.com/hmatsu47/items/d66830c8a00c21f5edad rel=noopener>https://qiita.com/hmatsu47/items/d66830c8a00c21f5edad</a></p><a href=#トランザクション><h3 id=トランザクション><span class=hanchor arialabel=Anchor># </span>トランザクション</h3></a><p>INSERT, UPDATE文を複数送るとき、その一部だけがデータベースに反映されると、一時的にせよ、データベース全体としてデータが不整合な状態となります。トランザクションを使うことでそれらを同時に実行させられます。</p><p>BEGINから始まりCOMMIT/ROLLBACKで終わる。</p><p>WAL(Write Ahead Logging)</p><p>TODO: FOR UPDATEとの違い
FOR UPDATE（先行して行ロックを獲得したトランザクションがロックを開放する/ロックがタイムアウトするまで待たされる）
NOWAIT（ロックが獲得できなかったときは即時にエラーを返す）
SKIP LOCKED（即時に獲得可能なロックのみ獲得して結果を返す）
<a href="https://www.informit.com/articles/article.aspx?p=29312" rel=noopener>https://www.informit.com/articles/article.aspx?p=29312</a></p><ul><li><a href=https://qiita.com/_natsu_no_yuki_/items/e1db2a132cbff740896d rel=noopener>ネストさせたいときはSAVEPOINT</a></li></ul><table><thead><tr><th>BEGIN文</th><th>SAVEPOINT文</th></tr></thead><tbody><tr><td>BEGIN</td><td>SAVEPOINT hoge</td></tr><tr><td>COMMIT</td><td>RELEASE SAVEPOINT hoge</td></tr><tr><td>ROLLBACK</td><td>ROLLBACK TO SAVEPOINT hoge</td></tr></tbody></table><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>tx</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;INSERT INTO test_user(name) VALUES(?)&#34;</span><span class=p>,</span> <span class=s>&#34;TRANS&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// run something
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// もとの状態に戻す
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// クエリを実行する
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>tx</span><span class=p>.</span><span class=nf>Commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#preparedstatement><h3 id=preparedstatement><span class=hanchor arialabel=Anchor># </span>PreparedStatement</h3></a><p>INSERT文など値は違えど同じクエリを大量に実行したいとき毎回クエリを解析せず最初に1回解析すれば後はそれを使い回して高速化しようという機能です。(多分パースしてクエリプランナーに突っ込んだ状態にしてあるだけ)</p><ul><li>Go標準のSQLパッケージはプレースホルダを用いたクエリは暗黙的にPreparedStatementを使っている</li><li>同じクエリではないとき段階を踏む上でコストが掛かり遅くなる(ADMIN PREPAREが多くなる)
そこで<code>interpolateParams=true</code>を使ってPreparedStatementを減らせる
<a href=http://dsas.blog.klab.org/archives/52191467.html rel=noopener>http://dsas.blog.klab.org/archives/52191467.html</a></li><li>トランザクション中にPreparedStatementするときは先にCloseしてCommitしないと不整合が起こる</li><li>クエリのプレースホルダーはSQLインジェクション対策にもなる。fmt.Sprintf()で作らないようにする。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// interpolateParams=true
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;root:password@tcp(localhost:3306)/test?interpolateParams=true&amp;collation=utf8mb4_bin&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// SQL文を受け取って解析し、値があればいつでも実行できる状態にする
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// PreparedStatementを関数の終わりで終了させる
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>defer</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// SQL文に必要な値をセットして実行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><a href=#生成カラムgenerated-column><h3 id=生成カラムgenerated-column><span class=hanchor arialabel=Anchor># </span>生成カラム(generated column)</h3></a><p><a href=https://qiita.com/hmatsu47/items/128ece7276e4deac1477 rel=noopener>https://qiita.com/hmatsu47/items/128ece7276e4deac1477</a>
他のカラムのデータを使って新しいカラムを作る</p><ul><li>VIRTUAL トランザクションが入ったときにデータを生成する</li><li>STORED INSERTしたときにデータを生成する</li></ul><p>NOT NULLを用いれば制約に合わないものがきたらエラーを吐かせて、データに制約を作ることができる
CHECKでやれって話
<a href=https://yakst.com/ja/posts/2834 rel=noopener>https://yakst.com/ja/posts/2834</a>
VIRTUALのとき仮想列と呼びそれを使ったINDEXを仮想インデックスと呼ぶ
この設計において、仮想列は簡単に追加して削除することができ、かつテーブル全体をリビルドする必要もない。これにより関連するテーブルのスキーマ変更がとても簡単かつ高速になる。</p><p>高速な仮想列の管理
<code>mysql> ALTER TABLE t ADD new_col INT GENERATED ALWAYS AS (a - b) VIRTUAL;</code></p><a href=#メモリ最適化><h3 id=メモリ最適化><span class=hanchor arialabel=Anchor># </span>メモリ最適化</h3></a><p><a href=https://dev.mysql.com/doc/refman/5.6/ja/data-size.html rel=noopener>https://dev.mysql.com/doc/refman/5.6/ja/data-size.html</a>
<code>MEDIUMINT</code> <code>INT</code>の25%削減
<code>NOT NULL</code> null確認の処理がなくなる</p><p>できるだけ少なく
<a href="https://phpjavascriptroom.com/?t=mysql&p=columntype" rel=noopener>https://phpjavascriptroom.com/?t=mysql&p=columntype</a></p><a href=#キーキャッシュ><h3 id=キーキャッシュ><span class=hanchor arialabel=Anchor># </span>キーキャッシュ</h3></a><p>MyISAM
<a href=https://dev.mysql.com/doc/refman/5.6/ja/myisam-key-cache.html rel=noopener>https://dev.mysql.com/doc/refman/5.6/ja/myisam-key-cache.html</a>
テーブルブロックとは？</p><p>ページングに注意すべきキャッシュ
InnoDB バッファプール
MyISAM キーキャッシュ
MySQL クエリーキャッシュ</p><p>頻繁な更新を実行するアプリケーションでは、多くの場合に少数のカラムのある多数のテーブルを使用し、大量のデータを解析するアプリケーションでは、多くの場合に多数のカラムのある少数のテーブルを使用します。</p><p>正規形</p><p>InnoDB は、ほとんどのデータまたはすべてのデータをメモリーに保持する汎用的で永続的な方法を提供</p><p>tmpfs
セッションとは？</p><a href=#orm-orマッパー><h3 id=orm-orマッパー><span class=hanchor arialabel=Anchor># </span>ORM O/Rマッパー</h3></a><p>開発効率を上げる為のSQLのラッパー(クエリービルダー)
ex.) gorm</p><a href=#mysql設定><h3 id=mysql設定><span class=hanchor arialabel=Anchor># </span>MySQL設定</h3></a><p>別のサーバーからDBへアクセスできるようにする
<code>/etc/mysql/mysql.conf.d/mysqld.cnf</code>
<code>bind-address = 127.0.0.1</code>をコメントアウト
<code>bind-address = 0.0.0.0</code></p><p><a href=http://dsas.blog.klab.org/archives/50860867.html rel=noopener>http://dsas.blog.klab.org/archives/50860867.html</a></p><ul><li>グローバルバッファ mysqld全体でそのバッファが1つだけ確保されるもの</li><li>スレッドバッファ スレッド(コネクション)ごとに確保されるもの
チューニングの際にはグローバル/スレッドの違いを意識するようにしましょう。 なぜなら、スレッドバッファに多くのメモリを割り当てると、コネクションが増えたとたんにアッという間にメモリ不足になってしまうからです。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>max_connections=1024
</span></span><span class=line><span class=cl>query_cache_type=ON
</span></span><span class=line><span class=cl># innoDB全体で一つ生成されるグローバルバッファ(別鯖なら搭載メモリの80%)
</span></span><span class=line><span class=cl>innodb_buffer_pool_size = 1GB
</span></span><span class=line><span class=cl># InnoDBの内部データなどを保持する足りないとエラーログが出るからその時増やす
</span></span><span class=line><span class=cl>#innodb_additional_mem_pool_size = 30MB ←これあるとダメ
</span></span><span class=line><span class=cl># innoDBの更新ログを保持するメモリ
</span></span><span class=line><span class=cl>innodb_log_buffer_size = 16MB
</span></span><span class=line><span class=cl># innodb_log_fileがいっぱいになると、メモリ上のinnodb_buffer_poolの中の更新された部分のデータを、ディスク上のInnoDBのデータファイルに書き出すしくみになっているから
</span></span><span class=line><span class=cl>innodb_log_file_size = 128MB
</span></span><span class=line><span class=cl># ORDER BYやGROUP BYのときに使われるメモリ上の領域
</span></span><span class=line><span class=cl>innodb_sort_buffer_size = 4MB
</span></span><span class=line><span class=cl>read_rnd_buffer_size = 2MB #
</span></span><span class=line><span class=cl>key_buffer_size = 256MB
</span></span><span class=line><span class=cl># 1に設定するとトランザクション単位でログを出力するが 2 を指定すると1秒間に1回ログを吐く。0だとログも1秒に1回。TODO違いをみる
</span></span><span class=line><span class=cl>innodb_flush_log_at_trx_commit = 0
</span></span><span class=line><span class=cl>innodb_flush_log_at_trx_commit = 2
</span></span><span class=line><span class=cl># データファイル、ログファイルの読み書き方式を指定する(実験する価値はある)
</span></span><span class=line><span class=cl>innodb_flush_method = O_DIRECT
</span></span><span class=line><span class=cl># 再起動試験対策
</span></span><span class=line><span class=cl>innodb_buffer_pool_dump_at_shutdown = ON
</span></span><span class=line><span class=cl>innodb_buffer_pool_load_at_startup = ON
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ mysql -u isucari -p
</span></span><span class=line><span class=cl>pass: isucari
</span></span><span class=line><span class=cl>$ sudo journalctl -u isucari.golang
</span></span><span class=line><span class=cl>sudo rm /var/log/mysql/mysql-slow.log
</span></span><span class=line><span class=cl>sudo systemctl restart mysql
</span></span><span class=line><span class=cl>sudo rm /var/log/nginx/access.log
</span></span><span class=line><span class=cl>sudo nginx -t
</span></span><span class=line><span class=cl>sudo systemctl reload nginx
</span></span><span class=line><span class=cl>cd ~/isucari/webapp/go
</span></span><span class=line><span class=cl>make
</span></span><span class=line><span class=cl>cd -
</span></span><span class=line><span class=cl>sudo systemctl restart isucari.golang
</span></span></code></pre></td></tr></table></div></div><a href=#スロークエリ-1><h3 id=スロークエリ-1><span class=hanchor arialabel=Anchor># </span>スロークエリ</h3></a><p><code>/etc/mysql/mysql.conf.d/mysqld.cnf</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>slow_query_log</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>slow_query_log_file</span><span class=o>=</span>/var/log/mysql/mysql-slow.log
</span></span><span class=line><span class=cl><span class=nv>long_query_time</span><span class=o>=</span><span class=m>0</span> <span class=c1># 全てのクエリを書き込んで解析ツールに渡す</span>
</span></span><span class=line><span class=cl><span class=nv>log_queries_not_using_indexes</span><span class=o>=</span><span class=m>1</span> <span class=c1># インデックスを使っていないクエリも出力する</span>
</span></span></code></pre></td></tr></table></div></div><p><code>sudo mysqldumpslow -s t -t 10 /path/to/slow.log</code>
<code>pt-query-digest /path/to/slow.log</code></p><p>複数のSQLクエリをIN、JOIN、LIMIT句、外部キーでまとめる(N+1問題など)
不要なカラムやクエリを削除する
転送量を減らす。取得するカラムを減らす、特にでかいもの(<code>VARCHAR(4096)</code>など)が入っているのは削るべき
<a href=https://qiita.com/ikenji/items/b868877492fee60d85ce rel=noopener>https://qiita.com/ikenji/items/b868877492fee60d85ce</a></p><p><strong>INDEX</strong>
B+ツリーのインデックスを適切に設定することで検索速度を高める。二分探索ができるものなら速くなる。
更に言えば上記のBツリーインデックスとハッシュインデックスが存在し、ハッシュインデックスの方が速いが、等価比較しかできない。MySQLは自動的にそれらの選択をしている。
これが多すぎるとINSERTでくそおもになるので注意</p><p>ここで役立つコマンド
<code>mysql -uユーザ名 -pパスワード DB名 -e'EXPLAIN ~~;'</code></p><p>LIKEも最初の方がワイルドカードではなければ使える</p><ul><li>速くなるもの WHERE, ORDER BY, JOIN句</li><li>効かないもの LIKE, OR, 演算, 関数処理, IS NULL, 否定形</li><li>NOT NULLを出来る限りつける</li><li>ORをUNION/UNION ALLに変換する</li><li>ORDER BYでDESCとASCの混合->MySQL 8.0では
<a href=https://dev.mysql.com/doc/refman/8.0/ja/descending-indexes.html rel=noopener>降順インデックス</a>で適用できる</li><li><a href=https://dev.mysql.com/doc/refman/8.0/ja/creating-spatial-indexes.html rel=noopener>空間インデックス</a> <code>SRID 0</code>を付ける
<a href=https://matsuu.hatenablog.com/entry/2020/09/13/131145 rel=noopener>https://matsuu.hatenablog.com/entry/2020/09/13/131145</a></li></ul><p>プレフィックスインデックス
非常に長い文字列にインデックスを付ける必要がある場合、値全体ではなく最初の数文字にインデックスを付けることで、記憶域を節約し、パフォーマンスを改善することができます。</p><ul><li>プレフィックスインデックスでは、選択性も低下するため、十分な選択性が得られる長さを持ち、記憶域を節約するくらい短いプレフィックスを選択すること</li><li>欠点として、ORDER BY 句や GROUP BY 句を使用するクエリにプレフィックスインデックスを使用できない</li><li>適切なサイズは、下記クエリで選択性を計測し、収束する値を見ることで発見できる。選択性とは、インデックス付けされた値の数と、テーブル内の行の合計数の比率のこと</li></ul><p>マルチインデックス
<a href=https://qiita.com/rm-rf-slant/items/8023500788352646b6c2 rel=noopener>クエリ文がINDEX作成時のカラム順に基づいていないと、INDEXが使えない</a></p><ul><li>等しい (=)、より大きい (>)、より小さい (&lt;)、BETWEENなどの検索条件のWHERE句で使用されるか、結合に含まれる列を、先頭に配置する</li><li>クエリによるカラム順序の制限がない場合、最も選択的な列をインデックスの先頭に配置する。カラム毎の選択性は下記クエリで計測する</li><li>ちゃんと出来てないとEXPLAIN type=index:フルインデックススキャンと言われる
1種類の値に対し多くのデータが存在するようなカラムを先に置く
重複の多いものを先に置く
それに伴うようにクエリのカラムを先に置く</li></ul><p><a href=https://lukesilvia.hatenablog.com/entry/20080315/1205583930 rel=noopener>https://lukesilvia.hatenablog.com/entry/20080315/1205583930</a>
Using filesort
レコードをソートして取り出す方法を決定するには、MySQL はパスを余分に実行しなくてはならないことを示す。 join type に従ってすべてのレコードをスキャンし、WHERE 条件に一致する全てのレコードに、ソートキー + 行ポインタを格納して、ソートは実行される。 その後キーがソートされる。 最後に、ソートされた順にレコードが取り出される。</p><p>Using temporary
クエリの解決に MySQL で結果を保持するテンポラリテーブルの作成が必要であることを示す。これは一般に、GROUP BY を実行したカラムセットと異なるカラムセットに対して ORDER BY を実行した場合に発生する。
UNIONとかも&mldr;？</p><p><a href=https://qiita.com/katsukii/items/3409e3c3c96580d37c2b rel=noopener>https://qiita.com/katsukii/items/3409e3c3c96580d37c2b</a>
<a href=https://nishinatoshiharu.com/overview-multicolumn-indexes/ rel=noopener>https://nishinatoshiharu.com/overview-multicolumn-indexes/</a></p><p>インデックスオンリースキャン
SELECTするカラムが少ないときINDEXにそのカラムを置くとそれを取ってくるだけでよい</p><a href=#クエリーキャッシュ-qcache><h3 id=クエリーキャッシュ-qcache><span class=hanchor arialabel=Anchor># </span>クエリーキャッシュ Qcache</h3></a><p>※注意
<a href=https://yakst.com/ja/posts/4612 rel=noopener>MySQL 8.0以降には存在しない</a>
メモリ上にクエリのバイト列とその結果を保存して再度同じ(大文字・小文字を区別する)クエリが来たらDBを探さずそれを返す。更新がかかるとキャッシュがフラッシュされる。
ディスクI/Oの多発の解決
INSERT,UPDATEが少なくSELECTが多いアプリに有効</p><p><a href=https://qiita.com/ryurock/items/9f561e486bfba4221747 rel=noopener>MySQL クエリーキャッシュ 【チューニング方法とかも】</a></p><hr><p>SQLで画像を入れるとAXと呼ばれるやつが入るらしい
<a href=https://stackoverflow.com/questions/52426874/how-do-i-extract-microsoft-sql-varbinarymax-field-to-image-using-golang rel=noopener>https://stackoverflow.com/questions/52426874/how-do-i-extract-microsoft-sql-varbinarymax-field-to-image-using-golang</a></p><p><code>キーキャッシュのヒット率 = 100 - ( key_reads / key_read_requests × 100 )</code>
mysqlをmariadbに変える? (あまり必要はない)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -LsS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup <span class=p>|</span> sudo bash
</span></span><span class=line><span class=cl>$ sudo apt install mariadb-server
</span></span><span class=line><span class=cl>$ <span class=c1>#このあと/etc/mysql/mysql.conf.d/mysqld.cnfに書いてたやつを/etc/mysql/mariadb.conf.d/50-server.cnfに書く</span>
</span></span></code></pre></td></tr></table></div></div><p><del>proxysqlを利用する？</del> <del>mariadbなら</del>そのままquery cache使えばよさそう</p><p><a href=http://dsas.blog.klab.org/archives/50860867.html rel=noopener>http://dsas.blog.klab.org/archives/50860867.html</a></p><a href=#再起試験対策><h3 id=再起試験対策><span class=hanchor arialabel=Anchor># </span>再起試験対策</h3></a><p>1台目サーバと2台目サーバの再起動タイミングがずれるとアプリからのDB接続に失敗
<code>/etc/systemd/system/isuumo.go.service</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>StartLimitBurst=999 # 失敗して再起動するのを何回行うか デフォルトは5
</span></span></code></pre></td></tr></table></div></div><p>再起動試験用DB待ち</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// main関数内に置く
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>waitDB</span><span class=p>(</span><span class=nx>db</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>go</span> <span class=nf>pollDB</span><span class=p>(</span><span class=nx>db</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>waitDB</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to ping DB: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Retrying...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>pollDB</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to ping DB: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><a href=#golang><h4 id=golang><span class=hanchor arialabel=Anchor># </span>golang</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=nx>dbx</span><span class=p>.</span><span class=nf>SetMaxIdleConns</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span> <span class=c1>// デフォルトだと2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>dbx</span><span class=p>.</span><span class=nf>SetConnMaxLifetime</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1>// 一応セット
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>dbx</span><span class=p>.</span><span class=nf>SetConnMaxIdleTime</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1>// 一応セット go1.15以上
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// goroutineを生やしすぎてもタイムアウトする https://www.sambaiz.net/article/61/
</span></span></span><span class=line><span class=cl><span class=c1>// Keep-AliveするとTCPコネクションを使い回し、名前解決やコネクション(3 way handshake)を毎回行わなくてよくなる
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=p>.</span><span class=nx>DefaultTransport</span><span class=p>.(</span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Transport</span><span class=p>).</span><span class=nx>MaxIdleConns</span> <span class=p>=</span> <span class=mi>0</span> <span class=c1>// 無制限 デフォルトだと100
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=p>.</span><span class=nx>DefaultTransport</span><span class=p>.(</span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Transport</span><span class=p>).</span><span class=nx>MaxIdleConnsPerHost</span> <span class=p>=</span> <span class=mi>1024</span> <span class=c1>// 0にすると2になっちゃう
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=p>.</span><span class=nx>DefaultTransport</span><span class=p>.(</span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Transport</span><span class=p>).</span><span class=nx>ForceAttemptHTTP2</span> <span class=p>=</span> <span class=kc>true</span> <span class=c1>// go1.13以上
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=p>.</span><span class=nx>DefaultClient</span><span class=p>.</span><span class=nx>Timeout</span> <span class=p>=</span> <span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span> <span class=c1>// 問題の切り分け用
</span></span></span></code></pre></td></tr></table></div></div><p><a href=https://qiita.com/go_sagawa/items/11929cd0883608a6888d rel=noopener>https://qiita.com/go_sagawa/items/11929cd0883608a6888d</a></p><ul><li>redis</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo add-apt-repository ppa:chris-lea/redis-server
</span></span><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install redis
</span></span></code></pre></td></tr></table></div></div><p><code>sudo nano /etc/redis/redis.conf</code>
<code>bind 127.0.0.1 ::1</code>のコメントアウト
<code>protected-mode yes</code>→<code>protected-mode no</code>
<code>requirepass hogehoge</code>に</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo systemctl unmask redis-server
</span></span><span class=line><span class=cl>sudo systemctl enable redis-server
</span></span><span class=line><span class=cl>sudo systemctl restart redis-server
</span></span></code></pre></td></tr></table></div></div><p><code>sudo echo never > /sys/kernel/mm/transparent_hugepage/enabled</code>
<code>sudo nano rc.local</code>→追記: <code>echo never > /sys/kernel/mm/transparent_hugepage/enabled</code></p><a href=#json><h3 id=json><span class=hanchor arialabel=Anchor># </span>JSON</h3></a><p><a href=https://github.com/json-iterator/go rel=noopener>https://github.com/json-iterator/go</a> を試してみる</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>var</span> <span class=nx>json</span> <span class=p>=</span> <span class=nx>jsoniter</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>EscapeHTML</span><span class=p>:</span>                    <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ObjectFieldMustBeSimpleString</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}.</span><span class=nf>Froze</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><a href=https://github.com/francoispqt/gojay rel=noopener>https://github.com/francoispqt/gojay</a>
<a href=https://github.com/goccy/go-json rel=noopener>https://github.com/goccy/go-json</a>
<a href=https://github.com/minio/simdjson-go rel=noopener>https://github.com/minio/simdjson-go</a>
Marshal / Encoder: goccy/go-json > francoispqt/gojay
Unmarshal: francoispqt/gojay > goccy/go-json
Decoder: francoispqt/gojay &#187; goccy/go-json</p><ul><li><p>メモリ上にキャッシュ</p><ul><li><code>map</code><ul><li>読み込み書き込みともに多く行う -> <code>sync.Map</code></li><li>読み込み多く行う -> <code>sync.RWMutex</code> + <code>map</code></li><li>ロックが気になるならシャーディングをするとよい<ul><li><a href=https://github.com/orcaman/concurrent-map rel=noopener>https://github.com/orcaman/concurrent-map</a></li><li><a href=https://github.com/FujishigeTemma/isucon9-qualify/compare/6eaa28f77cb8bac674c0b8cfbf9794d91999d026...49cede08c6fcf59afa29857559d146abb1e96165 rel=noopener>https://github.com/FujishigeTemma/isucon9-qualify/compare/6eaa28f77cb8bac674c0b8cfbf9794d91999d026...49cede08c6fcf59afa29857559d146abb1e96165</a></li><li>15～20個ずつになるくらいがよさそう？</li></ul></li></ul></li><li>sessionメモリに持つ<ul><li><code>gorilla/sessions</code>はコピーのために<code>encoding/gob</code>が無駄に呼び出される</li></ul></li></ul></li><li><p>singleflight</p><ul><li><code>x/sync/singleflight</code></li><li><code>sync.Map</code> + <code>sync.Cond</code><ul><li><a href=https://github.com/FujishigeTemma/isucon9-qualify/compare/2fb8ff382ce2f7b083ae9f343e5ae5d543bc5e65...6d3f1ab77bd377be00fdf6d5735ffe14b8f5afd6 rel=noopener>https://github.com/FujishigeTemma/isucon9-qualify/compare/2fb8ff382ce2f7b083ae9f343e5ae5d543bc5e65...6d3f1ab77bd377be00fdf6d5735ffe14b8f5afd6</a></li></ul></li><li><code>go-chi/httpcoala</code><ul><li><a href=https://github.com/FujishigeTemma/isucon9-qualify/commit/495ae7ba4732b3bcb9c4a6795bea86dfac060c6c rel=noopener>https://github.com/FujishigeTemma/isucon9-qualify/commit/495ae7ba4732b3bcb9c4a6795bea86dfac060c6c</a></li></ul></li></ul></li><li><p>メモリ効率化</p><ul><li><code>sync.Pool</code><ul><li><a href=https://github.com/FujishigeTemma/isucon9-qualify/commit/4e7a9be6cbee699dc11db96c2134836dfd207def rel=noopener>https://github.com/FujishigeTemma/isucon9-qualify/commit/4e7a9be6cbee699dc11db96c2134836dfd207def</a></li></ul></li></ul></li><li><p>挿入後の結果をとらずに返す</p><ul><li>timeはミリ秒を四捨五入すること<code>.Round</code><ul><li>デフォルトが秒までだけど、<code>DATETIME</code>のあとに数字がある場合は異なるので要確認</li><li><a href=https://dev.mysql.com/doc/refman/5.6/ja/fractional-seconds.html rel=noopener>https://dev.mysql.com/doc/refman/5.6/ja/fractional-seconds.html</a></li></ul></li></ul></li><li><p>session</p><ul><li>自前の<code>interface</code>の変換なしの実装<ul><li><a href=https://github.com/FujishigeTemma/isucon9-qualify/commit/64d095a6400bbde6df4ed62d6ad9bd12dbc8a964 rel=noopener>https://github.com/FujishigeTemma/isucon9-qualify/commit/64d095a6400bbde6df4ed62d6ad9bd12dbc8a964</a></li></ul></li></ul></li><li><p><code>pat.Param</code></p><ul><li>自前の<code>interface</code>の変換なしの実装<ul><li><a href=https://github.com/FujishigeTemma/isucon9-qualify/compare/b87747c27f305927b40b86285b1642cbe52e1c55...68c236f9782f041bca64f185ae0a3fbec9122ee2 rel=noopener>https://github.com/FujishigeTemma/isucon9-qualify/compare/b87747c27f305927b40b86285b1642cbe52e1c55...68c236f9782f041bca64f185ae0a3fbec9122ee2</a></li></ul></li></ul></li><li><p>misc</p><ul><li>キーが100個程度までならmapよりarrayを線形探索したほうがよいらしい</li><li>sliceもmapもcapacityを指定する</li><li><code>i, item := range items</code>をすると<code>item</code>にコピーが走るので<code>items[i]</code>を使う</li><li>画像を返してる箇所はキャッシュのヘッダーを設定する</li><li>GOGC <code>400</code>～<code>1200</code>とか<ul><li>有効にしたときは<strong>毎回再起動すること</strong></li></ul></li></ul></li><li><p><a href=https://qiita.com/hmatsu47/items/354f979cde6ad91bcc6b rel=noopener>MySQL のパーティショニングで速くなる？ならない？問題、あらためて実験してみた</a></p></li><li><p>カバリングインデックス</p></li></ul><p><a href=http://akouryy.hatenablog.jp/entry/2020/09/13/130415 rel=noopener>http://akouryy.hatenablog.jp/entry/2020/09/13/130415</a></p><ul><li><a href=https://dev.mysql.com/doc/refman/5.6/ja/optimizing-innodb-bulk-data-loading.html rel=noopener>https://dev.mysql.com/doc/refman/5.6/ja/optimizing-innodb-bulk-data-loading.html</a></li></ul><a href=#mysql8><h4 id=mysql8><span class=hanchor arialabel=Anchor># </span>MySQL8</h4></a><ul><li>NOWAIT, SKIP LOCKED:
<a href=https://qiita.com/hmatsu47/items/7675b026e65762d2445f rel=noopener>https://qiita.com/hmatsu47/items/7675b026e65762d2445f</a></li><li>HASH JOIN:
<a href=https://qiita.com/hmatsu47/items/e473a3e566b910d61f5b rel=noopener>https://qiita.com/hmatsu47/items/e473a3e566b910d61f5b</a></li><li>Multi-valued index(jsonカラム用):
<a href=https://qiita.com/hmatsu47/items/3e49a473bc36aeefc706 rel=noopener>https://qiita.com/hmatsu47/items/3e49a473bc36aeefc706</a></li><li>GROUP BYをLATERALにする？:
<a href=https://qiita.com/hmatsu47/items/040d65d118d0ecec6381 rel=noopener>https://qiita.com/hmatsu47/items/040d65d118d0ecec6381</a></li></ul><p>パーティショニングとは</p><a href=#http-チューニング><h2 id=http-チューニング><span class=hanchor arialabel=Anchor># </span>HTTP チューニング</h2></a><p><a href=https://qiita.com/yumin/items/5de33b068ead564ebcbf rel=noopener>https://qiita.com/yumin/items/5de33b068ead564ebcbf</a></p><p><a href=https://github.com/go-martini/martini rel=noopener>martini</a>
<a href=https://github.com/gin-gonic/gin rel=noopener>gin</a></p><p>fasthttp
<a href=https://medium.com/eureka-engineering/net-http%E3%82%88%E3%82%8A10%E5%80%8D%E9%80%9F%E3%81%84valyala-fasthttp%E3%81%8C%E9%9D%A2%E7%99%BD%E3%81%9D%E3%81%86%E3%81%AA%E3%81%AE%E3%81%A7%E8%AA%BF%E6%9F%BB%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F%E4%BB%B6-a608fe197f1d rel=noopener>https://medium.com/eureka-engineering/net-http%E3%82%88%E3%82%8A10%E5%80%8D%E9%80%9F%E3%81%84valyala-fasthttp%E3%81%8C%E9%9D%A2%E7%99%BD%E3%81%9D%E3%81%86%E3%81%AA%E3%81%AE%E3%81%A7%E8%AA%BF%E6%9F%BB%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F%E4%BB%B6-a608fe197f1d</a></p><a href=#カーネルパラメータ-チューニング><h2 id=カーネルパラメータ-チューニング><span class=hanchor arialabel=Anchor># </span>カーネルパラメータ チューニング</h2></a><p><a href=https://ac-as.net/kernel-parameter-performance-tuning/ rel=noopener>【Linux】カーネルパラメータのパフォーマンスチューニングについて</a></p><a href=#ファイルディスクリプタの上限><h3 id=ファイルディスクリプタの上限><span class=hanchor arialabel=Anchor># </span>ファイルディスクリプタの上限</h3></a><p><code>ulimit -l 10000</code></p><p>sshだとulimitできない
<a href=https://yohei-a.hatenablog.jp/entry/20090310/1236706236 rel=noopener>https://yohei-a.hatenablog.jp/entry/20090310/1236706236</a></p><p><a href=http://ramblog.blog129.fc2.com/blog-category-4.html rel=noopener>http://ramblog.blog129.fc2.com/blog-category-4.html</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/systemd/system/*.service
</span></span><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>LimitNOFILE=65535
</span></span></code></pre></td></tr></table></div></div><a href=#カーネルパラメータ><h3 id=カーネルパラメータ><span class=hanchor arialabel=Anchor># </span>カーネルパラメータ</h3></a><p>上ほど優先順位高い(同じ名前のfileをoverrideする)
<code>/etc/sysctl.d/*.conf</code>
<code>/run/sysctl.d/*.conf</code>
<code>/usr/lib/sysctl.d/*.conf</code>
すべての設定ファイルは、どのディレクトリにあるかに関わらず、ファイル名の並び順で辞書順にソートされます。複数のファイルが同じオプションを指定している場合は、辞書的に最新の名前を持つファイルのエントリが優先されます。ファイルの順序を簡単にするために、すべてのファイル名の前に 2 桁の数字とダッシュを付けることをお勧めします。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># /etc/sysctl.d/100-isucon.conf
</span></span><span class=line><span class=cl># maxconnection を増やす
</span></span><span class=line><span class=cl>net.core.somaxconn = 32768                  # 32768 (2^15) くらいまで大きくしても良いかも。
</span></span><span class=line><span class=cl>net.ipv4.ip_local_port_range = 10000 60999  # port の範囲を広げる
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># tcp connection の再利用を有効化
</span></span><span class=line><span class=cl>net.ipv4.tcp_tw_reuse = 1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># tcp connection が FIN-WAIT2 から TIME_WAIT に状態が変化するまでの時間
</span></span><span class=line><span class=cl>net.ipv4.tcp_fin_timeout = 10               # デフォルト 60。CPU 負荷を減らせるが、短すぎると危ういかも？
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># TIME_WAIT状態にある tcp connection 数の上限
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_tw_buckets = 2000000       # デフォルトは 32768(=2^15) くらい
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># パケット受信時にキューにつなぐことのできるパケットの最大数
</span></span><span class=line><span class=cl>net.core.netdev_max_backlog = 8192          # デフォルトは 1000 くらい
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 新規コネクション開始時のSYNパケットを受信した際の処理待ちキューの上限値
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_syn_backlog = 1024         # デフォルトは 128 くらい
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># window size scalingの有効化(ネットワークの帯域幅とメモリ使用量のトレードオフ)
</span></span><span class=line><span class=cl>net.ipv4.tcp_window_scaling = 1             # デフォルトで1になっているはず
</span></span><span class=line><span class=cl># すべての種類のsocketに基本設定されているbufferのsize デフォルトは 212992(=13*2^14) くらい
</span></span><span class=line><span class=cl>net.core.rmem_default = 253952
</span></span><span class=line><span class=cl>net.core.wmem_default = 253952
</span></span><span class=line><span class=cl>net.core.rmem_max = 16777216
</span></span><span class=line><span class=cl>net.core.wmem_max = 16777216
</span></span><span class=line><span class=cl># TCP socket buffer sizeの変更 デフォルトは 212992(=13*2^14) くらい
</span></span><span class=line><span class=cl>net.ipv4.tcp_rmem = 253952 253952 16777216  # min / default / max
</span></span><span class=line><span class=cl>net.ipv4.tcp_wmem = 253952 253952 16777216  # min / default / max
</span></span><span class=line><span class=cl># TCP用に使用できる合計メモリサイズを指定
</span></span><span class=line><span class=cl>net.ipv4.tcp_mem = 185688 247584 371376     # min / pressure / max; pressureの値を超えるとTCP memory pressureの状態になり、以降ソケットは指定されたmin値のメモリバッファのサイズを持つようになる
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># カーネルレベルでのファイルディスクリプタ上限数変更
</span></span><span class=line><span class=cl># プロセス単位のチューニングをやったけど、こっちもやっておく
</span></span><span class=line><span class=cl>fs.file-max=65535
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 3-way-handshakeの簡略化
</span></span><span class=line><span class=cl># 相手側のサーバーがONにしていないとデータが2回送られてオーバーヘッドになるので一回やってみてスコアが上がらなかったら切る
</span></span><span class=line><span class=cl>net.ipv4.tcp_fastopen = 3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 輻輳制御アルゴリズム TCP BBR の有効化
</span></span><span class=line><span class=cl># `uname -r`が4.9以上で`sysctl net.ipv4.tcp_available_congestion_control`にbbrが含まれている場合　
</span></span><span class=line><span class=cl># net.ipv4.tcp_congestion_control = bbr # 輻輳制御アルゴリズムをbbrに
</span></span><span class=line><span class=cl># net.core.default_qdisc = fq # キューイングアルゴリズムをfqに
</span></span></code></pre></td></tr></table></div></div><p><a href=https://html5experts.jp/jxck/3529/ rel=noopener>https://html5experts.jp/jxck/3529/</a>
<a href=https://ac-as.net/kernel-parameter-performance-tuning/ rel=noopener>https://ac-as.net/kernel-parameter-performance-tuning/</a>
φ(.. )ﾒﾓｼﾃｵｺｳ /proc/sys/net/ipv4/tcp_fastopenに設定する内容とか実装
<a href=https://kernhack.hatenablog.com/entry/2013/05/25/115634 rel=noopener>https://kernhack.hatenablog.com/entry/2013/05/25/115634</a></p><a href=#nginx-リバースプロキシチューニング><h2 id=nginx-リバースプロキシチューニング><span class=hanchor arialabel=Anchor># </span>Nginx (リバースプロキシ)チューニング</h2></a><a href=#サーバー分割><h3 id=サーバー分割><span class=hanchor arialabel=Anchor># </span>サーバー分割</h3></a><p><strong>DB分ける</strong>
<strong>リクエストのロードバランス</strong>
ロードバランサー
セッションパーシステンス</p><p>worker_processesにそれぞれ均等にworker_connectionsが分配される訳ではないので余裕をもって設定すべき
<a href=https://nrok81.hatenablog.com/entry/2014/11/12/191240 rel=noopener>https://nrok81.hatenablog.com/entry/2014/11/12/191240</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>worker_processes</span><span class=w>  </span><span class=n>auto</span><span class=p>;</span><span class=w>  </span><span class=c1># コア数と同じ数まで増やすと良いかも
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1># nginx worker の設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>worker_rlimit_nofile</span><span class=w>  </span><span class=mi>4096</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>events</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>worker_connections</span><span class=w>  </span><span class=mi>1024</span><span class=p>;</span><span class=w>  </span><span class=c1># 128より大きくするなら、 5_os にしたがって max connection 数を増やす必要あり（デフォルトで`net.core.somaxconn` が 128 くらいで制限かけられてるので）。さらに大きくするなら worker_rlimit_nofile も大きくする（file descriptor数の制限を緩める)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># multi_accept on;         # error が出るリスクあり。defaultはoff。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># accept_mutex_delay 100ms;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>http</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log_format</span><span class=w> </span><span class=n>main</span><span class=w> </span><span class=s1>&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; $status $body_bytes_sent &#34;$http_referer&#34; &#34;$http_user_agent&#34; $request_time&#39;</span><span class=p>;</span><span class=w>   </span><span class=c1># kataribe 用の log format
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>access_log</span><span class=w>  </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>log</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>access</span><span class=p>.</span><span class=n>log</span><span class=w>  </span><span class=n>main</span><span class=p>;</span><span class=w>   </span><span class=c1># これはしばらく on にして、最後に off にすると良さそう。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># access_log  off;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># 基本設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>sendfile</span><span class=w>    </span><span class=k>on</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tcp_nopush</span><span class=w>  </span><span class=k>on</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tcp_nodelay</span><span class=w> </span><span class=k>on</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>types_hash_max_size</span><span class=w> </span><span class=mi>2048</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>server_tokens</span><span class=w>    </span><span class=n>off</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>open_file_cache</span><span class=w> </span><span class=n>max</span><span class=o>=</span><span class=mi>100</span><span class=w> </span><span class=n>inactive</span><span class=o>=</span><span class=mi>65</span><span class=n>s</span><span class=p>;</span><span class=w> </span><span class=c1># file descriptor のキャッシュ。入れた方が良い。 20s-&gt;65s
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># proxy buffer の設定。白金動物園が設定してた。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>proxy_buffers</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=mi>32</span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxy_buffer_size</span><span class=w> </span><span class=mi>8</span><span class=n>k</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># mime.type の設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>include</span><span class=w>       </span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>mime</span><span class=p>.</span><span class=n>types</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># Keepalive 設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># ベンチマークとの相性次第ではkeepalive off;にしたほうがいい
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># keepalive off;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1># ベンチは1分しか回らない
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>keepalive_timeout</span><span class=w> </span><span class=mi>65</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>keepalive_requests</span><span class=w> </span><span class=mi>500</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># Proxy cache 設定。使いどころがあれば。1mでkey8,000個。1gまでcache。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>proxy_cache_path</span><span class=w> </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>cache</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>cache</span><span class=w> </span><span class=n>levels</span><span class=o>=</span><span class=mi>1</span><span class=p>:</span><span class=mi>2</span><span class=w> </span><span class=n>keys_zone</span><span class=o>=</span><span class=n>zone1</span><span class=p>:</span><span class=mi>1</span><span class=n>m</span><span class=w> </span><span class=n>max_size</span><span class=o>=</span><span class=mi>1</span><span class=n>g</span><span class=w> </span><span class=n>inactive</span><span class=o>=</span><span class=mi>1</span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxy_temp_path</span><span class=w>  </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>cache</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>tmp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># オリジンから来るCache-Controlを無視する必要があるなら。。。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>#proxy_ignore_headers Cache-Control;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># unix domain socket 設定1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>upstream</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>unix</span><span class=p>:</span><span class=o>/</span><span class=n>run</span><span class=o>/</span><span class=n>unicorn</span><span class=p>.</span><span class=n>sock</span><span class=p>;</span><span class=w>  </span><span class=c1># systemd を使ってると `/tmp` 以下が使えない。appのディレクトリに`tmp`ディレクトリ作って配置する方がpermissionでハマらずに済んで良いかも。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1># 複数serverへ proxy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>upstream</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=mi>192</span><span class=p>.</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>1</span><span class=p>:</span><span class=mi>5000</span><span class=w> </span><span class=n>weight</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span><span class=w>  </span><span class=c1># weight をつけるとproxyする量を変更可能。defaultは1。多いほどたくさんrequestを振り分ける。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=mi>192</span><span class=p>.</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>2</span><span class=p>:</span><span class=mi>5000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=mi>192</span><span class=p>.</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>3</span><span class=p>:</span><span class=mi>5000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># keepalive 60;  # app server への connection を keepalive する。app が対応できるならした方が良い。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>server</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># reverse proxy の 設定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=p>:</span><span class=mi>3000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># proxy_http_version 1.1;          # app server との connection を keepalive するなら追加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_set_header Connection &#34;&#34;;  # app server との connection を keepalive するなら追加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># Unix domain socket の設定2。設定1と組み合わせて。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># 簡易静的ファイルをNginx配信
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>root</span><span class=w> </span><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=k>user</span><span class=o>/</span><span class=n>app</span><span class=o>/</span><span class=n>public</span><span class=o>/</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>try_files</span><span class=w> </span><span class=err>$</span><span class=n>uri</span><span class=w> </span><span class=err>$</span><span class=n>uri</span><span class=o>/</span><span class=w> </span><span class=o>@</span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>@</span><span class=n>app</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># For Server Sent Event
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=n>api</span><span class=o>/</span><span class=n>stream</span><span class=o>/</span><span class=n>rooms</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># &#34;magic trio&#34; making EventSource working through Nginx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>proxy_http_version</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_set_header</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>chunked_transfer_encoding</span><span class=w> </span><span class=n>off</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># These are not an official way
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_buffering off;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_cache off;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=p>:</span><span class=mi>8080</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># For websocket
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=n>wsapp</span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_http_version</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_set_header</span><span class=w> </span><span class=n>Upgrade</span><span class=w> </span><span class=err>$</span><span class=n>http_upgrade</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_set_header</span><span class=w> </span><span class=n>Connection</span><span class=w> </span><span class=s2>&#34;upgrade&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>wsbackend</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># Proxy cache
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>/</span><span class=n>cached</span><span class=o>/</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>proxy_cache</span><span class=w> </span><span class=n>zone1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># proxy_set_header X-Real-IP $remote_addr;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_set_header Host $http_host;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>proxy_pass</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=p>:</span><span class=mi>9292</span><span class=o>/</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1># デフォルトでは 200, 301, 302 だけキャッシュされる。proxy_cache_valid で増やせる。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_cache_valid 200 301 302 3s;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># cookie を key に含めることもできる。デフォルトは $scheme$proxy_host$request_uri;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># proxy_cache_key $proxy_host$request_uri$cookie_jessionid;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1># レスポンスヘッダにキャッシュヒットしたかどうかを含める
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>add_header</span><span class=w> </span><span class=n>X</span><span class=o>-</span><span class=n>Nginx</span><span class=o>-</span><span class=n>Cache</span><span class=w> </span><span class=err>$</span><span class=n>upstream_cache_status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1># static file の配信用の root
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>root</span><span class=w> </span><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>isucon</span><span class=o>/</span><span class=n>webapp</span><span class=o>/</span><span class=n>public</span><span class=o>/</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>location</span><span class=w> </span><span class=o>~</span><span class=w> </span><span class=p>.</span><span class=o>*</span><span class=err>\</span><span class=p>.(</span><span class=n>htm</span><span class=o>|</span><span class=n>html</span><span class=o>|</span><span class=n>css</span><span class=o>|</span><span class=n>js</span><span class=o>|</span><span class=n>jpg</span><span class=o>|</span><span class=n>png</span><span class=o>|</span><span class=n>gif</span><span class=o>|</span><span class=n>ico</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>expires</span><span class=w> </span><span class=mi>24</span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>add_header</span><span class=w> </span><span class=n>Cache</span><span class=o>-</span><span class=n>Control</span><span class=w> </span><span class=n>public</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>open_file_cache</span><span class=w> </span><span class=n>max</span><span class=o>=</span><span class=mi>100</span><span class=p>;</span><span class=w>  </span><span class=c1># file descriptor などを cache
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>gzip</span><span class=w> </span><span class=k>on</span><span class=p>;</span><span class=w>  </span><span class=c1># cpu 使うのでメリット・デメリット見極める必要あり。gzip_static 使えるなら事前にgzip圧縮した上でそちらを使う。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>gzip_types</span><span class=w> </span><span class=kt>text</span><span class=o>/</span><span class=n>html</span><span class=w> </span><span class=kt>text</span><span class=o>/</span><span class=n>css</span><span class=w> </span><span class=n>application</span><span class=o>/</span><span class=n>javascript</span><span class=w> </span><span class=n>application</span><span class=o>/</span><span class=n>json</span><span class=w> </span><span class=n>font</span><span class=o>/</span><span class=n>woff</span><span class=w> </span><span class=n>font</span><span class=o>/</span><span class=n>ttf</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>gif</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>png</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>jpeg</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>svg</span><span class=o>+</span><span class=n>xml</span><span class=w> </span><span class=n>image</span><span class=o>/</span><span class=n>x</span><span class=o>-</span><span class=n>icon</span><span class=w> </span><span class=n>application</span><span class=o>/</span><span class=n>octet</span><span class=o>-</span><span class=n>stream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>gzip_disable</span><span class=w> </span><span class=s2>&#34;msie6&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>gzip_static</span><span class=w> </span><span class=k>on</span><span class=p>;</span><span class=w>  </span><span class=c1># nginx configure時に --with-http_gzip_static_module 必要
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>user www-data;
</span></span><span class=line><span class=cl>pid /run/nginx.pid;
</span></span><span class=line><span class=cl>include /etc/nginx/modules-enabled/*.conf;
</span></span><span class=line><span class=cl>worker_rlimit_nofile 100000;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>error_log  /var/log/nginx/error.log error;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>http {
</span></span><span class=line><span class=cl>    default_type  application/octet-stream;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    client_max_body_size 10m;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # TLS configuration
</span></span><span class=line><span class=cl>    ssl_protocols TLSv1.2;
</span></span><span class=line><span class=cl>    ssl_prefer_server_ciphers on;
</span></span><span class=line><span class=cl>    ssl_ciphers &#39;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384&#39;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	server {
</span></span><span class=line><span class=cl>	    listen 443 ssl http2;
</span></span><span class=line><span class=cl>	    server_name isucon9.catatsuy.org;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	    ssl_certificate /etc/nginx/ssl/fullchain.pem;
</span></span><span class=line><span class=cl>	    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		root /home/isucon/isucari/webapp/public;
</span></span><span class=line><span class=cl>		location /static/ {
</span></span><span class=line><span class=cl>			add_header Cache-Control &#34;public max-age=86400&#34;;
</span></span><span class=line><span class=cl>		}
</span></span><span class=line><span class=cl>		location /upload/ {
</span></span><span class=line><span class=cl>			add_header Cache-Control &#34;public max-age=86400&#34;;
</span></span><span class=line><span class=cl>		}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	    location / {
</span></span><span class=line><span class=cl>		proxy_pass http://app;
</span></span><span class=line><span class=cl>		proxy_set_header Host $host;
</span></span><span class=line><span class=cl>	    }
</span></span><span class=line><span class=cl>	    location /login {
</span></span><span class=line><span class=cl>		proxy_pass http://login_app;
</span></span><span class=line><span class=cl>		proxy_set_header Host $host;
</span></span><span class=line><span class=cl>	    }
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#初期設定><h3 id=初期設定><span class=hanchor arialabel=Anchor># </span>初期設定</h3></a><p><a href=https://wiki.trap.jp/user/to-hutohu/memo/ISUCON%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88 rel=noopener>https://wiki.trap.jp/user/to-hutohu/memo/ISUCON%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88</a></p><a href=#os><h4 id=os><span class=hanchor arialabel=Anchor># </span>OS</h4></a><p>設定したら<code>sudo sysctl -p {{filename}}</code>で反映する
実行中のプロセスには反映されないからプロセスの再起動が必要</p><p>備考: <code>net.ipv4.ip_, net.ipv4.ip_local_portrange, net.ipv4.tcp, net.ipv4.icmp_*</code>はipv6にも適用される</p><a href=#nginx><h4 id=nginx><span class=hanchor arialabel=Anchor># </span>nginx</h4></a><p><code>$ sudo cp *.conf *.conf.bk</code>
<code>/etc/nginx/nginx.conf</code>
<code>/etc/nginx/sites-enabled/*.conf</code> (ここでは<code>http</code>ブロック内しか変更できない)
<code>/etc/nginx/sites-available/*.conf</code>に書いて↑ではエイリアスを貼るのが正解
<a href=https://wiki.trap.jp/user/to-hutohu/memo/ISUCON%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88#head10 rel=noopener>https://wiki.trap.jp/user/to-hutohu/memo/ISUCON%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88#head10</a></p><p>nginxとアプリケーションの間をunix domain socket
<code>Unix domain socket</code>は後回し
<a href=https://qiita.com/ihsiek/items/11106ce7a13e09b61547#web%E3%82%B5%E3%83%BC%E3%83%90 rel=noopener>https://qiita.com/ihsiek/items/11106ce7a13e09b61547#web%E3%82%B5%E3%83%BC%E3%83%90</a>
<code>index.html</code>を配信してるところをnginxで返すようにする</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    # index.htmlの配信
</span></span><span class=line><span class=cl>    location ~ ^/(?:login|register|timeline|categories|sell|items|buy/complete|transactions|users)(?!.*.(?:json|png)) {
</span></span><span class=line><span class=cl>        try_files $uri /index.html;
</span></span><span class=line><span class=cl>    }
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>server {
</span></span><span class=line><span class=cl>    listen       80 default_server;
</span></span><span class=line><span class=cl>    server_name  _;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location / {
</span></span><span class=line><span class=cl>         root /home/isucon/torb/webapp/static/;
</span></span><span class=line><span class=cl>         try_files $uri $uri/ @app;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location @app {
</span></span><span class=line><span class=cl>        proxy_set_header Host $host;
</span></span><span class=line><span class=cl>        proxy_pass   http://127.0.0.1:8080;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    proxy_buffer_size 128k;
</span></span><span class=line><span class=cl>    proxy_buffers 32 128k;
</span></span><span class=line><span class=cl>    proxy_busy_buffers_size 128k;
</span></span></code></pre></td></tr></table></div></div><p>h2cの有効化(意味なさそうなのでhttpsを使ってhttp2を使うべき)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>server {
</span></span><span class=line><span class=cl>    listen 80 http2;
</span></span></code></pre></td></tr></table></div></div><h5 id=heading></h5><p>設定</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>worker_processes auto;
</span></span><span class=line><span class=cl>worker_rlimit_nofile 4096;
</span></span><span class=line><span class=cl>events {
</span></span><span class=line><span class=cl>    worker_connections 1024; # net.core.somaxconnとworker_rlimit_nofileも大きくする
</span></span><span class=line><span class=cl>    #multi_accept on; # error が出るリスクあり。defaultはoff
</span></span><span class=line><span class=cl>    #accept_mutex_delay 100ms;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>nginx の worker_connections は worker 当たりの同時接続数だと思ってたけどどうも違うっぽい
<a href=https://nrok81.hatenablog.com/entry/2014/11/12/191240 rel=noopener>https://nrok81.hatenablog.com/entry/2014/11/12/191240</a></p><a href=#ログ設定-httpディレクティブの中><h5 id=ログ設定-httpディレクティブの中><span class=hanchor arialabel=Anchor># </span>ログ設定 httpディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>log_format main &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; $status $body_bytes_sent &#34;$http_referer&#34; &#34;$http_user_agent&#34; $request_time&#39;;
</span></span><span class=line><span class=cl>access_log /tmp/access.log main;
</span></span><span class=line><span class=cl>#access_log off;
</span></span></code></pre></td></tr></table></div></div><a href=#基本設定-httpディレクティブの中><h5 id=基本設定-httpディレクティブの中><span class=hanchor arialabel=Anchor># </span>基本設定 httpディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sendfile on;
</span></span><span class=line><span class=cl>tcp_nopush on;
</span></span><span class=line><span class=cl>tcp_nodelay on;
</span></span><span class=line><span class=cl>types_hash_max_size 2048;
</span></span><span class=line><span class=cl>server_tokens off;
</span></span><span class=line><span class=cl>open_file_cache max=100 inactive=20s; # file descriptorのキャッシュ
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># proxy bufferの設定
</span></span><span class=line><span class=cl>proxy_buffers 100 32k;
</span></span><span class=line><span class=cl>proxy_buffer_size 8k;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># keepaliveの設定
</span></span><span class=line><span class=cl>#keepalive off; # ベンチマークとの相性次第ではoffにしたほうがいい
</span></span><span class=line><span class=cl>keepalive_timeout 120;
</span></span><span class=line><span class=cl>keepalive_requests 1048576;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># proxy cacheの設定
</span></span><span class=line><span class=cl>proxy_cache_path /var/cache/nginx/cache levels=1:2 keys_zone=zone1:1m max_size=1g inactive=1h;
</span></span><span class=line><span class=cl>proxy_temp_path  /var/cache/nginx/tmp;
</span></span><span class=line><span class=cl>#proxy_ignore_headers Cache-Control; # upstreamから来るCache-Controlを無視する必要があるなら
</span></span></code></pre></td></tr></table></div></div><a href=#upstream設定-httpディレクティブの中><h5 id=upstream設定-httpディレクティブの中><span class=hanchor arialabel=Anchor># </span>upstream設定 httpディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>upstream app {
</span></span><span class=line><span class=cl>    server 127.0.0.1:8000;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    keepalive 256;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#reverse-proxy設定-serverディレクティブの中><h5 id=reverse-proxy設定-serverディレクティブの中><span class=hanchor arialabel=Anchor># </span>reverse proxy設定 serverディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>location /initialize {
</span></span><span class=line><span class=cl>    proxy_http_version 1.1;
</span></span><span class=line><span class=cl>    proxy_set_header Connection &#34;&#34;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    proxy_read_timeout 120;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    #proxy_cache zone1;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    proxy_set_header Host $host;
</span></span><span class=line><span class=cl>    proxy_set_header X-Real-IP $remote_addr;
</span></span><span class=line><span class=cl>    proxy_set_header X-Forwarded-Proto $scheme;
</span></span><span class=line><span class=cl>    proxy_set_header X-Forwarded-Host $host;
</span></span><span class=line><span class=cl>    proxy_set_header X-Forwarded-Server $host;
</span></span><span class=line><span class=cl>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    proxy_pass http://app;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#静的配信設定-serverディレクティブの中><h5 id=静的配信設定-serverディレクティブの中><span class=hanchor arialabel=Anchor># </span>静的配信設定 serverディレクティブの中</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># static file の配信用の root
</span></span><span class=line><span class=cl>root /home/isucon/webapp/public/;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>location ~ .*\.(htm|html|css|js|eot|svg|ttf|woff|woff2|gif|jpg|png|ico) {
</span></span><span class=line><span class=cl>    expires 24h;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    gzip off;
</span></span><span class=line><span class=cl>    #gzip on; # CPUを使うのでメリット・デメリット見極める必要あり。gzip_staticが使えるなら事前にgzip圧縮した上でそちらを使う
</span></span><span class=line><span class=cl>    #gzip_types *;
</span></span><span class=line><span class=cl>    #gzip_disable &#34;msie6&#34;;
</span></span><span class=line><span class=cl>    #gzip_static on;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#gzip><h5 id=gzip><span class=hanchor arialabel=Anchor># </span>gzip</h5></a><ul><li>できればgzip_staticを使う<ul><li>圧縮コマンド <code>find ./* | xargs -I {} sh -c 'gzip -9 -v -N -c {} > {}.gz'</code><ul><li>元のファイルを残して圧縮する</li></ul></li></ul></li></ul><hr><a href=#メモ><h3 id=メモ><span class=hanchor arialabel=Anchor># </span>メモ</h3></a><p><a href=https://github.com/cs3238-tsuzu/sqlx-selector rel=noopener>https://github.com/cs3238-tsuzu/sqlx-selector</a></p><p><a href=http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if rel=noopener>http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if</a>
<a href=https://stackoverflow.com/questions/8591600/nginx-proxy-pass-based-on-whether-request-method-is-post-put-or-delete rel=noopener>https://stackoverflow.com/questions/8591600/nginx-proxy-pass-based-on-whether-request-method-is-post-put-or-delete</a></p><p>得点につながるエンドポイントの確認
大量アクセスかつ同じものが使える→singleflight</p><p>lockfree map</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://anko9801.github.io/blog/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Jacky Zhao using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2022</p><ul><li><a href=https://anko9801.github.io/blog/>Home</a></li><li><a href=https://twitter.com/Anko_9801>Twitter</a></li><li><a href=https://github.com/anko9801>Github</a></li></ul></footer></div></div></body></html>